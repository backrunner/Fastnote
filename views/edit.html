<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote - 编辑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/edit.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });

        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');
        //ipc
        const {
            ipcRenderer
        } = require('electron');

        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery

        var settings;

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
        });

        function settingsInit(settings) {
            var cssText = "";
            //build css
            if (settings == null) {
                //read error
                cssText += 'body {font-family:Source Han Sans CN !important;}';
            } else {
                //read success
                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ' !important;}';
                } else {
                    cssText += 'body {font-family:Source Han Sans CN !important;}';
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;
        }
    </script>
</head>

<body>
    <script>
        //全局变量定义
        var note;
    </script>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="edit-title">编辑笔记</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 999;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- main -->
    <div class="container-edit">
        <div class="container-edit-header">
            <span id="edit-header-time">创建时间：</span>
        </div>
        <textarea class="text-edit" id="text-edit"></textarea>
    </div>
    <div class="container-footer">
        <div class="control-group">
            <button class="br-btn btn-noback" id="edit-btn-save">保存</button>
            <button class="br-btn btn-noback" id="edit-btn-cancel">取消</button>
        </div>
    </div>
    <script>
        $("#edit-btn-save").click(function () {
            var text = $("#text-edit").val().trim();
            if (text != null && text != "") {
                note.text = text;
                ipcRenderer.send('update-edit-note', note);
                window.close();
            } else {
                //error
                displayInfobar("error", "笔记内容不能为空");
            }
        });

        var isComboKey = false;
        $("#text-edit").keydown(function (e) {
            var ctrlKey = e.ctrlKey || e.metaKey;
            if (ctrlKey && e.keyCode == 13) {
                var text = $("#text-edit").val().trim();
                if (!isComboKey) {
                    isComboKey = true;
                    if (text != null && text != "") {
                        note.text = text;
                        ipcRenderer.send('update-edit-note', note);
                        isComboKey = false;
                        window.close();
                    } else {
                        isComboKey = false;
                        displayInfobar("error", "笔记内容不能为空");
                    }
                }
            }
        });

        $("#edit-btn-cancel").click(function () {
            window.close();
        });

        ipcRenderer.on('message', (event, {
            type,
            data
        }) => {
            switch (type) {
                case 'init':
                    note = data;
                    //初始化textarea
                    $("#text-edit").text(note.text);
                    //初始化title
                    $("#edit-title").append(" #" + note.id);
                    $("title").append(" - #" + note.id);
                    //初始化header
                    $("#edit-header-time").append(note.time);
                    break;
            }
        });
        ipcRenderer.send("requestInit");
    </script>
</body>