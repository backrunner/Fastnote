<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote - 回收站</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/recyclebin.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script src="js/han.simple.js"></script>
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');

        const {
            ipcRenderer
        } = require('electron');

        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery

        var settings;

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
        });

        function settingsInit(settings) {
            var cssText = "";
            //build css
            if (settings == null) {
                //read error
                cssText += 'body {font-family:Source Han Sans CN !important;}'; //font
                cssText += '.note-content p {text-align:justify;}'; //note text align
            } else {
                //read success
                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ' !important;}'; //font
                } else {
                    cssText += 'body {font-family:Source Han Sans CN !important;}';
                }
                if (typeof settings.notealign != 'undefined') {
                    cssText += '.note-content p {text-align:' + settings.notealign + ';}'; //note text align
                } else {
                    cssText += '.note-content p {text-align:justify;}';
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;
        }
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">回收站</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- main -->
    <div class="recycle-container">
        <div class="recycle-list-container">
            <div class="note-empty recycle-empty col-lg-12">
                <span>回收站内没有笔记</span>
            </div>
            <div class="note-list recycle-list">
            </div>
        </div>
    </div>
    <script>
        //保存所有的notes
        var notes = new Array();

        //显示没有笔记的界面
        function showNoteEmpty() {
            var node_empty = document.getElementsByClassName('note-empty')[0];
            var node_list = document.getElementsByClassName('note-list')[0];
            node_empty.setAttribute("style", "display:flex;");
            node_list.setAttribute("style", "display:none;");
        }

        function showNoteEmpty_Anim() {
            $('.recycle-empty').css('display', 'flex');
            $('.recycle-empty').animateCss('fadeIn');
            var node_list = document.getElementsByClassName('recycle-list')[0];
            node_list.setAttribute("style", "display:none;");
        }
        //显示有笔记的界面
        function showNoteList() {
            var node_empty = document.getElementsByClassName('note-empty')[0];
            var node_list = document.getElementsByClassName('note-list')[0];
            node_empty.setAttribute("style", "display:none;");
            node_list.setAttribute("style", "display:block;");
        }

        //清空列表内的笔记DOM
        function clearNoteList() {
            var node_list = document.getElementsByClassName('note-list')[0];
            node_list.innerHTML = "";
        }

        //添加笔记至Array
        function addNoteToArray(id, time, rawtime, updatetime, updaterawtime, text, offset, timezone) {
            var note = {
                id: id,
                time: time,
                rawtime: rawtime,
                updatetime: updatetime,
                updaterawtime: updaterawtime,
                text: text,
                offset: offset,
                timezone: timezone
            }
            notes.push(note);
        }
        //添加Note Obj至Array
        function addNoteObjToArray(note) {
            notes.push(note);
        }
        //刷新note-list
        function refreshNoteList(callback) {
            clearNoteList(); //先清空
            notes.sort(sortNotes); //排序
            notes.forEach(function (note) {
                renderNote(note.id, note.time, note.updatetime, note.text);
            });
            //绑定右键事件
            bindRightClickEvent();
            //callback
            if (typeof (callback) === 'function') {
                callback();
            }
        }
        //清空notes数组
        function clearNoteArray() {
            notes = new Array();
        }
        //排序笔记
        function sortNotes(a, b) {
            if (a.id > b.id) {
                return -1;
            } else if (a.id < b.id) {
                return 1;
            } else {
                return 0;
            }
        }
        //从数组中删除一项
        async function deleteNoteFromArr(id) {
            notes.every(function (note, i) {
                if (note.id == id) {
                    notes.splice(i, 1);
                    return false;
                }
                return true; //every是true继续循环 false跳出
            });
        }

        //定义url过滤正则
        let reg_url =
            /(http|ftp|https|mailto):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#]*[\w\-\@?^=%&amp;/~\+#])?/gi;

        //渲染一条笔记
        function renderNote(id, time, updatetime, text) {
            var html = '<div class="note-wrapper"><div class="note" id="note_' + id +
                '"><div class="note-header"><p class="note-no han-element">';
            html += '#' + id + '</p>';
            //选择性显示时间
            if (typeof (updatetime) != 'undefined') {
                html += '<time><p class="note-time note-updatetime han-element">更新：' + insert_spacing(updatetime, 0.1) +
                    '</p>';
                html += '<p class="note-time han-element">创建：' + insert_spacing(time, 0.1) + '</p></time>';
            } else {
                html += '<time><p class="note-time han-element">' + insert_spacing(time, 0.1) + '</p></time>';
            }
            html += '</div><div class="note-content"><p class="note-text">';
            temp = text.split('<br/>');
            final_text = "";
            for (var i = 0; i < temp.length; i++) {
                s = $("#filter-x").text(temp[i]).html().replace(' ', '&nbsp;');
                console.log(s);
                final_text += s;
                final_text += "<br/>";
            }
            text = final_text;
            text = insert_spacing(text, 0.12);
            //自动识别网页
            html += text.replace(reg_url, function (result) {
                return '<a href="' + result + '">' + result + '</a>';
            });
            html += '</p></div></div></div>';
            $('.note-list').append($(html));
            //open external on os default webbrowser
            $('#note_' + id + ' a').click(function (e) {
                ipcRenderer.send('openExternalURL', $(this).attr('href'));
                e.preventDefault();
            });
        }

        //绑定note的双击折叠
        function bindNoteFoldDBL(id) {
            if ($('#note_' + id + ' .note-content').height() > 250) {
                $('#note_' + id + ' .note-content').addClass("note-overheight"); //process css
                $('#note_' + id + ' .note-content').dblclick(function () {
                    //process double click
                    if ($('#note_' + id + ' .note-content').height() > 250) {
                        $('#note_' + id + ' .note-content').animate({
                            height: "250px"
                        });
                        $('#note_' + id + ' .note-content').addClass("note-overheight");
                    } else {
                        $('#note_' + id + ' .note-content').css('height', 'auto');
                        var animate_height = $('#note_' + id + ' .note-content').height();
                        $('#note_' + id + ' .note-content').css('height', '250px');
                        $('#note_' + id + ' .note-content').animate({
                            height: animate_height
                        });
                        $('#note_' + id + ' .note-content').removeClass("note-overheight");
                    }
                });
            } else {
                $('#note_' + id + ' .note-content').removeClass("note-overheight");
            }
        }

        //在顶部渲染Note
        function renderNoteAtTop(id, time, updatetime, text) {
            //构造html
            var html = '<div class="note-wrapper"><div class="note" id="note_' + id +
                '"><div class="note-header"><p class="note-no">';
            html += '#' + id + '</p>';
            //选择性显示时间
            if (typeof (updatetime) != 'undefined') {
                html += '<time><p class="note-time note-updatetime han-element">更新：' + insert_spacing(updatetime, 0.1) +
                    '</p>';
                html += '<p class="note-time han-element">创建：' + insert_spacing(time, 0.1) + '</p></time>';
            } else {
                html += '<time><p class="note-time han-element">' + insert_spacing(time, 0.1) + '</p></time>';
            }
            html += '</div><div class="note-content"><p class="note-text">';
            temp = text.split('<br/>');
            final_text = "";
            for (var i = 0; i < temp.length; i++) {
                s = $("#filter-x").text(temp[i]).html().replace(' ', '&nbsp;');
                console.log(s);
                final_text += s;
                final_text += "<br/>";
            }
            text = final_text;
            text = insert_spacing(text, 0.12);
            //自动识别网页
            html += text.replace(reg_url, function (result) {
                return '<a href="' + result + '">' + result + '</a>';
            });
            html += '</p></div></div></div>';
            $('.note-list').prepend($(html));
            //animate
            $('#note_' + id).animateCss('fadeInLeft');
            //open external on os default webbrowser
            $('#note_' + id + ' a').click(function (e) {
                ipcRenderer.send('openExternalURL', $(this).attr('href'));
                e.preventDefault();
            });
            //bind dbl
            bindNoteFoldDBL(id);
        }

        //event recycle
        ipcRenderer.on('recycle-note', (event, data) => {
            if (notes.length <= 0) {
                showNoteList();
            }
            addNoteObjToArray(data);
            refreshNoteList(function () {
                bindNoteFoldDBL(data.id);
            });
            //animate
            $('#note_' + data.id).animateCss('fadeInLeft');
        });
    </script>

    <!-- rightclick menu -->
    <div class="rightclickmenu">
        <div class="list-group">
            <button type="button" class="btn-rightclick list-group-item" id="btn-restoreNote">还原</button>
            <button type="button" class="btn-rightclick list-group-item" id="btn-deleteNote">彻底删除</button>
        </div>
    </div>

    <span id="filter-x" style="display:none"></span>

    <script>
        var noteid_clicked = -1;
        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    if (noteid_clicked != -1) {
                        $('#note_' + noteid_clicked).parent().removeClass('note-selected');
                    }
                    $('.rightclickmenu').attr('style', 'display:block;' + 'left:' + e.clientX + 'px;top:' + e.clientY +
                        'px;z-index:1000;');
                    isRightClickMenuOpened = true;
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                    $(this).parent().addClass('note-selected');
                }
            });
        }
        $('body').click(function (e) {
            $('.rightclickmenu').attr('style', 'display:none;'); //右键菜单隐藏
            $('#note_' + noteid_clicked).parent().removeClass('note-selected');
            noteid_clicked = -1;
        });
        $('#note-list').scroll(function () {
            $('.rightclickmenu').attr('style', 'display:none;');
            $('#note_' + noteid_clicked).parent().removeClass('note-selected');
            noteid_clicked = -1;
        });
    </script>

    <script>
        require('../app/notes_recycle.js');
    </script>
</body>