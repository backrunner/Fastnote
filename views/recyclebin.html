<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote - 回收站</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/recyclebin.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script src="js/han.simple.js"></script>
    <script src="js/notes.render.js"></script>
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');
        let time = require('../app/tools/time.js');

        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;

        const {
            ipcRenderer
        } = require('electron');

        const WebFont = require('webfontloader');

        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery

        //import menu
        $.getScript('js/menu.recyclebin.js');

        var settings;

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
        });

        function settingsInit(settings) {
            var cssText = "";
            var font = "";
            //build css
            if (settings == null) {
                //read error
                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                font = 'Source Han Sans CN';
                //read error
                console.error('A error occured when reading settings.');
            } else {
                //read success
                //read success
                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                    font = settings.fontfamily;
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;';
                    font = 'Source Han Sans CN';
                }

                //笔记显示设置初始化
                cssText += '.note-content p{';
                if (typeof settings.fontsize != 'undefined'){
                    cssText += 'font-size:' + settings.fontsize + 'px !important;'; 
                }
                if (typeof settings.lineheight != 'undefined'){
                    cssText += 'line-height:' + settings.lineheight + 'px !important;'; 
                }
                if (typeof settings.textalign != 'undefined') {
                    cssText += 'text-align:' + settings.textalign + ' !important;'; //note text align
                }
                if (typeof settings.letterspacing != 'undefined'){
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'

                cssText += '.note-content a{';
                if (typeof settings.fontsize != 'undefined'){
                    cssText += 'font-size:' + settings.fontsize + 'px !important;'; 
                }
                if (typeof settings.letterspacing != 'undefined'){
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'
            }

            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            if (font == 'Source Han Sans CN'){
                loadWebfont(font);
            }
        }

        //加载webfont
        function loadWebfont(font){
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }
    </script>
</head>

<body class="recyclebin-body">
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">回收站</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- main -->
    <div class="recycle-container">
        <div class="recycle-list-container">
            <div class="note-empty recycle-empty col-lg-12">
                <span>回收站内没有便签</span>
            </div>
            <div class="note-list recycle-list">
            </div>
        </div>
    </div>
    <script>
        //event recycle
        ipcRenderer.on('recycle-note', (event, data) => {
            if (notes.length <= 0) {
                showNoteList();
            }
            addNoteObjToArray(data);
            refreshNoteList(function () {
                bindNoteFoldDBL(data.id);
            });
            //animate
            $('#note_' + data.id).animateCss('fadeInLeft');
        });
    </script>

    <span id="filter-x" style="display:none"></span>

    <script>
        var noteid_clicked = -1;
        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    if (noteid_clicked != -1) {
                        $('#note_' + noteid_clicked).parent().removeClass('note-selected');
                    }
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                    $(this).parent().addClass('note-selected');
                    menu_recyclebin.popup(remote.getCurrentWindow());
                }
            });
        }

        //bind resize
        $(window).resize(function () { //当浏览器大小变化时
            //调整note的高度
            $('.note-content').each(function () {
                if ($(this).attr('class').indexOf('note-overheight') == -1) {
                    $(this).css('height', 'auto');
                }
            });
        });
    </script>

    <script>
        $.getScript('../app/notes_recycle.js');
    </script>
</body>