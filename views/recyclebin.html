<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote - 回收站</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/recyclebin.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });
        //define const
        const remote = require('electron').remote;
        const app = remote.app;

        const {
            ipcRenderer
        } = require('electron');

        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">回收站</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- main -->
    <div class="recycle-container">
        <div class="recycle-list-container">
            <div class="note-empty recycle-empty col-lg-12">
                <span>回收站内没有笔记</span>
            </div>
            <div class="note-list recycle-list">
            </div>
        </div>
    </div>
    <script>
        //保存所有的notes
        var notes = new Array();

        //显示没有笔记的界面
        function showNoteEmpty() {
            var node_empty = document.getElementsByClassName('note-empty')[0];
            var node_list = document.getElementsByClassName('note-list')[0];
            node_empty.setAttribute("style", "display:flex;");
            node_list.setAttribute("style", "display:none;");
        }

        function showNoteEmpty_Anim() {
            $('.note-empty').css('display', 'flex');
            $('.note-empty').animateCss('fadeIn');
            var node_list = document.getElementsByClassName('note-list')[0];
            node_list.setAttribute("style", "display:none;");
        }
        //显示有笔记的界面
        function showNoteList() {
            var node_empty = document.getElementsByClassName('note-empty')[0];
            var node_list = document.getElementsByClassName('note-list')[0];
            node_empty.setAttribute("style", "display:none;");
            node_list.setAttribute("style", "display:block;");
        }

        //清空列表内的笔记DOM
        function clearNoteList() {
            var node_list = document.getElementsByClassName('note-list')[0];
            node_list.innerHTML = "";
        }

        //添加笔记至Array
        function addNoteToArray(id, time, rawtime, updatetime, updaterawtime, text, offset, timezone) {
            var note = {
                id: id,
                time: time,
                rawtime: rawtime,
                updatetime: updatetime,
                updaterawtime: updaterawtime,
                text: text,
                offset: offset,
                timezone: timezone
            }
            notes.push(note);
        }
        //添加Note Obj至Array
        function addNoteObjToArray(note) {
            notes.push(note);
        }
        //刷新note-list
        function refreshNoteList() {
            clearNoteList(); //先清空                
            notes.sort(sortNotes); //排序
            notes.forEach(function (note) {
                renderNote(note.id, note.time, note.updatetime, note.text);
            });
            //绑定右键事件
            bindRightClickEvent();
        }
        //清空notes数组
        function clearNoteArray() {
            notes = new Array();
        }
        //排序笔记
        function sortNotes(a, b) {
            if (a.id > b.id) {
                return -1;
            } else if (a.id < b.id) {
                return 1;
            } else {
                return 0;
            }
        }
        //从数组中删除一项
        async function deleteNoteFromArr(id) {
            notes.every(function (note, i) {
                if (note.id == id) {
                    notes.splice(i, 1);
                    return false;
                }
                return true; //every是true继续循环 false跳出
            });
        }
        //渲染一条笔记
        function renderNote(id, time, updatetime, text) {
            var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
            html += '#' + id + '</p>';
            //选择性显示时间
            if (typeof (updatetime) != 'undefined') {
                html += '<time><p class="note-time note-updatetime">更新：' + updatetime + '</p>';
                html += '<p class="note-time">创建：' + time + '</p></time>';
            } else {
                html += '<time><p class="note-time">' + time + '</p></time>';
            }
            html += '</div><div class="note-content"><p class="note-text">';
            html += text;
            html += '</p></div></div>';
            $('.note-list').append($(html));
        }
        //在顶部渲染Note
        function renderNoteAtTop(id, time, updatetime, text) {
            //构造html
            var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
            html += '#' + id + '</p>';
            //选择性显示时间
            if (typeof (updatetime) != 'undefined') {
                html += '<time><p class="note-time note-updatetime">更新：' + updatetime + '</p>';
                html += '<p class="note-time">创建：' + time + '</p></time>';
            } else {
                html += '<time><p class="note-time">' + time + '</p></time>';
            }
            html += '</div><div class="note-content"><p class="note-text">';
            html += text;
            html += '</p></div></div>';
            $('.note-list').prepend($(html));
            //animate
            $('#note_' + id).animateCss('fadeInLeft');
        }

        //event recycle
        ipcRenderer.on('recycle-note', (event, data) => {
            addNoteObjToArray(data);
            refreshNoteList();
            //animate
            $('#note_' + data.id).animateCss('fadeInLeft');
        });
    </script>

    <!-- rightclick menu -->
    <div class="rightclickmenu">
        <div class="list-group">
            <button type="button" class="btn-rightclick list-group-item" id="btn-restoreNote">还原</button>
            <button type="button" class="btn-rightclick list-group-item" id="btn-deleteNote">彻底删除</button>
        </div>
    </div>

    <script>
        let noteid_clicked = -1;
        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    if (noteid_clicked != -1) {
                        $('#note_' + noteid_clicked).removeClass('note-selected');
                    }
                    $('.rightclickmenu').attr('style', 'display:block;' + 'left:' + e.clientX + 'px;top:' + e.clientY +
                        'px;z-index:1000;');
                    isRightClickMenuOpened = true;
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                    $(this).addClass('note-selected');
                }
            });
        }
        $('body').click(function (e) {
            $('.rightclickmenu').attr('style', 'display:none;'); //右键菜单隐藏
            $('#note_' + noteid_clicked).removeClass('note-selected');
            noteid_clicked = -1;
        });
        $('.note-list').scroll(function () {
            $('.rightclickmenu').attr('style', 'display:none;');
            $('#note_' + noteid_clicked).removeClass('note-selected');
            noteid_clicked = -1;
        });
    </script>

    <script>
        require('../app/notes_recycle.js');
    </script>
</body>