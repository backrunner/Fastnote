<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote - 设置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/settings.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');

        const {dialog} = require('electron').remote;

        const {
            ipcRenderer
        } = require('electron');

        const WebFont = require('webfontloader');

        var settings;

        //读取设置
        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
        });

        //读取noteid
        storage.get('notesid', function (error, data) {
            if (error) {
                console.error(error);
                initNotesId(null);
                return;
            } else {
                //获取callback回传的json
                var notesid = data;
                initNotesId(notesid.id);
            }
        });

        function settingsInit(settings) {
            var cssText = "";
            //build css
            if (settings == null) {
                //read error
                initFont('Source Han Sans CN');
                //初始化设置
                //init auto update
                initAutoUpdate(true);

                //default settings
                initFontSize("16");
                initTextAlign("justify");
                initLineHeight("24");
                initLetterSpacing("0.06");
            } else {
                //read success
                //init font family
                if (typeof settings.fontfamily != 'undefined') {
                    initFont(settings.fontfamily);
                } else {
                    initFont('Source Han Sans CN');
                }
                //init auto update
                if (typeof settings.autoUpdateStatus != 'undefined'){
                    if (settings.autoUpdateStatus){
                        initAutoUpdate(true);
                    } else {
                        initAutoUpdate(false);
                    }
                } else {
                    initAutoUpdate(true);   //default true
                }

                if (typeof settings.fontsize != 'undefined'){
                    initFontSize(settings.fontsize);
                } else {
                    initFontSize("16");
                }
                if (typeof settings.textalign != 'undefined'){
                    initTextAlign(settings.textalign);
                } else {
                    initTextAlign("justify");
                }
                if (typeof settings.lineheight != 'undefined'){
                    initLineHeight(settings.lineheight);
                } else {
                    initLineHeight("24");
                }
                if (typeof settings.letterspacing != 'undefined'){
                    initLetterSpacing(settings.letterspacing);
                } else {
                    initLetterSpacing("0.06");
                }
            }
        }

        //初始化页面字体
        function initFont(font){
            var cssText = 'body {font-family:' + font +' !important;}';
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            //init settings ui
            initFontFamilySetting(font);

            if (font == 'Source Han Sans CN'){
                loadWebfont(font);
            }
        }

        //加载webfont
        function loadWebfont(font){
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }

        //初始化自动更新相关设置
        //status -> bool
        function initAutoUpdate(status){
            $(document).ready(function (){
                if (status){
                    $('#cb-autoUpdateEnabled').attr('checked',"true");
                    document.getElementById('select-updateChannel').disabled = false;
                } else {
                    document.getElementById('select-updateChannel').disabled = true;
                }
            });
        }

        //初始化Notesid
        function initNotesId(id){
            $(document).ready(function(){
                id = id - 1;    //存储的id是当前最后一个id+1
                if (typeof id == 'number' && id >= 0){
                    $('#span-notesId').html(id);
                } else {
                    $('#span-notesId').html('0');
                }
            });
        }

        //初始化显示设置选项
        function initFontFamilySetting(font){
            $(document).ready(function(){
                $('#select-fontfamily').val(font);
            });
        }
        function initFontSize(fontsize){
            $(document).ready(function(){
                $('#select-fontsize').val(fontsize);
            });
        }
        function initTextAlign(align){
            $(document).ready(function(){
                $('#select-textalign').val(align);
            });
        }
        function initLineHeight(lineheight){
            $(document).ready(function(){
                $('#select-lineheight').val(lineheight);
            });
        }
        function initLetterSpacing(letterspacing){
            $(document).ready(function(){
                $('#select-letterspacing').val(letterspacing);
            });
        }
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">设置</div>
        <div id="electron-titlebar" class="titlebar drag" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <div class="container-settings">
        <div class="settings-titles">
            <div class="settings-titles-block settings-titles-general settings-titles-clicked" data-target="settings-general">
                <i class="fa fa-cog fa-fw settings-titles-icon" aria-hidden="true"></i>
                <span class="settings-titles-span">通用</span>
            </div>
            <div class="settings-titles-block settings-titles-notes" data-target="settings-notes">
                <i class="fa fa-sticky-note-o fa-fw settings-titles-icon" aria-hidden="true"></i>
                <span class="settings-titles-span">便签</span>
            </div>
            <div class="settings-titles-block settings-titles-display" data-target="settings-display">
                <i class="fa fa-paint-brush fa-fw settings-titles-icon" aria-hidden="true"></i>
                <span class="settings-titles-span">显示</span>
            </div>
        </div>
        <script>
            //绑定点击事件
            $('.settings-titles-block').click(function(){
                $('.settings-titles-block').removeClass('settings-titles-clicked');
                $(this).addClass('settings-titles-clicked');
                $('.settings-sections').addClass('settings-sections-hidden');
                $('.'+$(this).attr('data-target')).removeClass('settings-sections-hidden');
            });
        </script>
        <!-- sections -->
        <div class="settings-sections settings-general">
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>启用自动更新</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <input class="settings-control-checkbox" type="checkbox" id="cb-autoUpdateEnabled" onclick="updateEnabledChanged(this);" />
                    <script>
                        function updateEnabledChanged(checkbox) {
                            if (checkbox.checked) {
                                document.getElementById('select-updateChannel').disabled = false;
                            } else {
                                document.getElementById('select-updateChannel').disabled = true;
                            }
                        }
                    </script>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>自动更新通道</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-updateChannel">
                        <option>Alpha</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>语言</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control">
                        <option>简体中文</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>重置设置</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <button class="btn btn-danger" id="btn-resetSettings" onclick="resetSettings();">重置</button>
                </div>
            </div>
        </div>
        <div class="settings-sections settings-notes settings-sections-hidden">
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>当前便签序号：</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <span id="span-notesId"></span>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>重置便签</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <button class="btn btn-danger" id="btn-resetNotes">重置</button>
                </div>
            </div>
        </div>
        <div class="settings-sections settings-display settings-sections-hidden">
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>字体</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-fontfamily">
                        <option style="font-family: Source Han Sans CN !important;" value="Source Han Sans CN">思源黑体</option>
                        <option style="font-family: Microsoft Yahei !important;" value="Microsoft Yahei">微软雅黑</option>
                        <option style="font-family: DengXian !important;" value="DengXian">等线</option>
                        <option style="font-family: Arial !important;" value="Arial">Arial</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>便签字号</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-fontsize">
                        <option style="font-size: 18px !important;" value="18">18px</option>
                        <option style="font-size: 17px !important;" value="17">17px</option>
                        <option style="font-size: 16px !important;" value="16">16px</option>
                        <option style="font-size: 15px !important;" value="15">15px</option>
                        <option style="font-size: 14px !important;" value="14">14px</option>
                        <option style="font-size: 13px !important;" value="13">13px</option>
                        <option style="font-size: 12px !important;" value="12">12px</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>内容对齐</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-textalign">
                        <option value="left">左对齐</option>
                        <option value="justify">两端对齐</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>便签行高</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-lineheight">
                        <option value="26">26px</option>
                        <option value="24">24px</option>
                        <option value="22">22px</option>
                        <option value="20">20px</option>
                        <option value="18">18px</option>
                    </select>
                </div>
            </div>
            <div class="settings-item">
                <div class="settings-item-child settings-item-title">
                    <span>便签字间距</span>
                </div>
                <div></div>
                <div class="settings-item-child settings-item-control">
                    <select class="form-control" id="select-letterspacing">
                        <option value="0.08">0.08em</option>
                        <option value="0.06">0.06em</option>
                        <option value="0.04">0.04em</option>
                        <option value="0.02">0.02em</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="setting-buttons">
            <button class="btn btn-danger" onclick='window.close();'>取消</button>
            <button class="btn btn-primary btn-brblue" onclick="saveSettings();">保存</button>
        </div>
    </div>

    <script>
        function saveSettings() {
            //获取通用设置
            var autoUpdateStatus = document.getElementById('cb-autoUpdateEnabled').checked;
            //获取显示设置
            var fontfamily = $('#select-fontfamily').val();
            var fontsize = $('#select-fontsize').val();
            var textalign = $('#select-textalign').val();
            var lineheight = $('#select-lineheight').val();
            var letterspacing = $('#select-letterspacing').val();

            //构造设置obj
            var settings = {
                autoUpdateStatus: autoUpdateStatus,
                fontfamily: fontfamily,
                fontsize: fontsize,
                textalign: textalign,
                lineheight: lineheight,
                letterspacing: letterspacing
            };

            //保存设置
            storage.set('settings', settings, function (error) {
                if (error) {
                    dialog.showMessageBox({
                        type: 'error',
                        title: '错误',
                        message: '保存设置时发生错误。',
                        detail: error
                    });
                } else {
                    //通知窗体刷新
                    ipcRenderer.send('reloadMainWindow');
                    ipcRenderer.send('reloadRecycleWindow');
                    ipcRenderer.send('reloadAllEditWindow');
                    //关闭窗体
                    window.close();
                }
            });
        }
    </script>

    <script>
        $.getScript('../app/notes_reset.js');

        function reloadNotesId() {
            storage.get('notesid', function (error, data) {
                if (error) {
                    console.error(error);
                    initNotesId(null);
                    return;
                } else {
                    //获取callback回传的json
                    var notesid = data;
                    initNotesId(notesid.id);
                }
            });
        }

        function resetSettings() {
            dialog.showMessageBox({
                type: "warning",
                buttons: ['取消', '确认'],
                defaultId: 0,
                title: '确认操作',
                message: '确定要重置设置吗？该操作将不可撤回。',
                detail: '所有已保存的设置都讲还原为默认值。'
            }, function (response) {
                if (response == 1) {
                    storage.remove('settings', function (error) {
                        if (error) {
                            console.error(error);
                            dialog.showMessageBox({
                                type: "error",
                                title: '错误',
                                message: '重置设置时遇到了错误。',
                                detail: error
                            });
                        } else {
                            //通知其他窗体重新载入
                            ipcRenderer.send('reloadMainWindow');
                            ipcRenderer.send('reloadRecycleWindow');
                            ipcRenderer.send('closeAllEditWindow');
                            dialog.showMessageBox({
                                type: "info",
                                title: '完成',
                                message: '设置已重置。'
                            });
                            ipcRenderer.send('reloadSettingsWindow');
                        }
                    });
                }
            });
        }
    </script>
</body>

</html>