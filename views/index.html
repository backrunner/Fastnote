<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (el.style[t] !== undefined) {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title">Fastnote</div>
        <div id="electron-titlebar" class="titlebar" style="z-index: 999;position: fixed !important;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- notes -->
    <div class="container-main">
        <div class="note-list col-lg-12" id="note-list"></div>
        <!-- empty -->
        <div class="note-empty col-lg-12">
            <span>您还没有建立任何的笔记</br>在下方你可以快速新建新笔记</span>
        </div>
        <script>
            //保存所有的notes
            var notes = new Array();

            //显示没有笔记的界面
            function showNoteEmpty() {
                var node_empty = document.getElementsByClassName('note-empty')[0];
                var node_list = document.getElementsByClassName('note-list')[0];
                node_empty.setAttribute("style", "display:flex;");
                node_list.setAttribute("style", "display:none;");
            }
            //显示有笔记的界面
            function showNoteList() {
                var node_empty = document.getElementsByClassName('note-empty')[0];
                var node_list = document.getElementsByClassName('note-list')[0];
                node_empty.setAttribute("style", "display:none;");
                node_list.setAttribute("style", "display:block;");
            }
            //清空列表内的笔记DOM
            function clearNoteList() {
                var node_list = document.getElementsByClassName('note-list')[0];
                node_list.innerHTML = "";
            }
            //渲染一条笔记
            function renderNote(id, time, text) {
                var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
                html += '#' + id;
                html += '</p><p class="note-time">';
                html += time;
                html += '</p></div><div class="note-content"><p class="note-text">';
                html += text;
                html += '</p></div></div>';
                $('.note-list').append($(html));
            }
            //在顶部渲染Note
            function renderNoteAtTop(id, time, text) {
                //构造html
                var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
                html += '#' + id;
                html += '</p><p class="note-time">';
                html += time;
                html += '</p></div><div class="note-content"><p class="note-text">';
                html += text;
                html += '</p></div></div>';
                $('.note-list').prepend($(html));
                //animate
                $('#note_' + id).animateCss('fadeInLeft');
            }
            //添加笔记至Array
            function addNoteToArray(id, time, rawtime, text, offset, timezone) {
                var note = {
                    id: id,
                    time: time,
                    rawtime: rawtime,
                    text: text,
                    offset: offset,
                    timezone: timezone
                }
                notes.push(note);
            }
            //添加Note Obj至Array
            function addNoteObjToArray(note) {
                notes.push(note);
            }
            //刷新note-list
            function refreshNoteList() {
                clearNoteList(); //先清空                
                notes.sort(sortNotes); //排序
                notes.forEach(function (note) {
                    renderNote(note.id, note.time, note.text);
                });
                //绑定右键事件
                bindRightClickEvent();
            }
            //清空notes数组
            function clearNoteArray() {
                notes = new Array();
            }
            //排序笔记
            function sortNotes(a, b) {
                if (a.id > b.id) {
                    return -1;
                } else if (a.id < b.id) {
                    return 1;
                } else {
                    return 0;
                }
            }

            function deleteNoteFromArr(id) {
                notes.every(function (note, i) {
                    if (note.id == id) {
                        notes.splice(i, 1);
                        return false;
                    }
                    return true; //every是true继续循环 false跳出
                });
            }
        </script>
    </div>

    <!-- new note -->
    <div class="fixed col-lg-12">
        <div class="container-newnote">
            <div class="lbl">
                <label>新建笔记</label>
            </div>
            <div class="control">
                <textarea id="note-text"></textarea>
            </div>
        </div>
    </div>

    <!-- rightclick menu -->
    <div class="rightclickmenu">
        <div class="list-group">
            <button type="button" class="btn-rightclick list-group-item" id="btn-editNote">编辑</button>
            <button type="button" class="btn-rightclick list-group-item" id="btn-deleteNote">删除</button>
        </div>
    </div>

    <script>
        var noteid_clicked = -1;
        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    $('.rightclickmenu').attr('style', 'display:block;' + 'left:' + e.clientX + 'px;top:' +
                        e.clientY +
                        'px;z-index:1000;');
                    isRightClickMenuOpened = true;
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                }
            });
        }
        $('body').click(function (e) {
            $('.rightclickmenu').attr('style', 'display:none;'); //右键菜单隐藏
            noteid_clicked = -1;
        });
        $('#note-list').scroll(function () {
            $('.rightclickmenu').attr('style', 'display:none;');
            noteid_clicked = -1;
        });
    </script>

    <script>
        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
        require('../app/notes.js');
    </script>

    <!-- update -->
    <div class="container-updater">
        <div class="update-block">
            <div class="update-title">
                <span id="update-title-span">新版本已下载：</span>
            </div>
            <div class="update-contents">
                <h1 class="update-contents-title">更新日志</h1>
                <div class="update-contents-details">
                </div>
            </div>

            <div class="update-contents update-contents-loading">
                <span id="update-loading-span">载入中……</span>
            </div>

            <div class="update-footer">
                <div class="control-group">
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-cancel">取消</button>
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-confirm">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ipcRenderer -->
    <script>
        const {
            ipcRenderer
        } = require('electron');

        ipcRenderer.on('message', (event, {
            message,
            data
        }) => {
            switch (message) {
                case 'checking-for-update':
                    console.log('checking for update...');
                    break;
                case 'update-available':
                    displayInfobar('update', '正在下载更新……');
                    break;
                case 'downloadProgress':
                    console.log('progress', data);
                    document.getElementById('update-progress').value = data.percent || 0;
                    break;
                case 'isUpdateNow':
                    console.log('isupdatenow');
                    $('.container-updater').css('display', 'block');
                    $('.container-updater').animateCss('fadeIn', function () {
                        $.getJSON(`http://update.backrunner.top/fastnote/${process.platform}/var.json`,
                            function (result) {
                                if (result != null && result != "" && result != undefined) {
                                    try {                                      
                                        $('#update-title-span').append(result.var);
                                        $('.update-contents-details').append(result.text);
                                        $('.update-contents-loading').css('display','none');

                                    } catch (err) {
                                        console.error(err);
                                        $('#update-loading-span').innerHTML = "更新日志加载失败";
                                    }
                                } else {
                                    $('#update-loading-span').innerHTML = "更新日志加载失败";
                                }
                            });
                    });

                    break;
            }
        });
        //绑定按钮事件
        $('#btn-update-cancel').on('click', function () {
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
        });
        $('btn-update-confirm').on('click', function () {
            ipcRenderer.send('updateNow');
        })
    </script>
</body>

</html>