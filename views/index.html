<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script>
        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof(el.style[t]) !== undefined) {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });

        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">Fastnote</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- notes -->
    <div class="container-main">
        <div class="note-list col-lg-12" id="note-list"></div>
        <!-- empty -->
        <div class="note-empty col-lg-12">
            <span>您还没有建立任何的笔记</br>在下方你可以快速新建新笔记</span>
        </div>
        <script>
            //保存所有的notes
            var notes = new Array();

            //显示没有笔记的界面
            function showNoteEmpty() {
                var node_empty = document.getElementsByClassName('note-empty')[0];
                var node_list = document.getElementsByClassName('note-list')[0];
                node_empty.setAttribute("style", "display:flex;");
                node_list.setAttribute("style", "display:none;");
            }

            function showNoteEmpty_Anim() {
                $('.note-empty').css('display', 'flex');
                $('.note-empty').animateCss('fadeIn');
                var node_list = document.getElementsByClassName('note-list')[0];
                node_list.setAttribute("style", "display:none;");
            }
            //显示有笔记的界面
            function showNoteList() {
                var node_empty = document.getElementsByClassName('note-empty')[0];
                var node_list = document.getElementsByClassName('note-list')[0];
                node_empty.setAttribute("style", "display:none;");
                node_list.setAttribute("style", "display:block;");
            }
            //清空列表内的笔记DOM
            function clearNoteList() {
                var node_list = document.getElementsByClassName('note-list')[0];
                node_list.innerHTML = "";
            }
            //定义url过滤正则
            let reg_url =
                /(http|ftp|https|mailto):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#]*[\w\-\@?^=%&amp;/~\+#])?/gi;
            //渲染一条笔记
            function renderNote(id, time, text) {
                var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
                html += '#' + id;
                html += '</p><p class="note-time">';
                html += time;
                html += '</p></div><div class="note-content"><p class="note-text">';
                //自动识别网页
                html += text.replace(reg_url, function (result) {
                    return '<a href="' + result + '">' + result + '</a>';
                });
                html += '</p></div></div>';
                $('.note-list').append($(html));
                //open external on os default webbrowser
                $('#note_' + id+' a').click(function (e) {
                    ipcRenderer.send('openExternalURL', $(this).attr('href'));
                    e.preventDefault();
                });
            }
            //在顶部渲染Note
            function renderNoteAtTop(id, time, text) {
                //构造html
                var html = '<div class="note" id="note_' + id + '"><div class="note-header"><p class="note-no">';
                html += '#' + id;
                html += '</p><p class="note-time">';
                html += time;
                html += '</p></div><div class="note-content"><p class="note-text">';
                //自动识别网页
                html += text.replace(reg_url, function (result) {
                    return '<a href="' + result + '">' + result + '</a>';
                });
                html += '</p></div></div>';
                $('.note-list').prepend($(html));
                //animate
                $('#note_' + id).animateCss('fadeInLeft');
                //open external on os default webbrowser
                $('#note_' + id+' a').click(function (e) {
                    ipcRenderer.send('openExternalURL', $(this).attr('href'));
                    e.preventDefault();
                });
            }
            //添加笔记至Array
            function addNoteToArray(id, time, rawtime, text, offset, timezone) {
                var note = {
                    id: id,
                    time: time,
                    rawtime: rawtime,
                    text: text,
                    offset: offset,
                    timezone: timezone
                }
                notes.push(note);
            }
            //添加Note Obj至Array
            function addNoteObjToArray(note) {
                notes.push(note);
            }
            //刷新note-list
            function refreshNoteList() {
                clearNoteList(); //先清空                
                notes.sort(sortNotes); //排序
                notes.forEach(function (note) {
                    renderNote(note.id, note.time, note.text);
                });
                //绑定右键事件
                bindRightClickEvent();
            }
            //清空notes数组
            function clearNoteArray() {
                notes = new Array();
            }
            //排序笔记
            function sortNotes(a, b) {
                if (a.id > b.id) {
                    return -1;
                } else if (a.id < b.id) {
                    return 1;
                } else {
                    return 0;
                }
            }

            function deleteNoteFromArr(id) {
                notes.every(function (note, i) {
                    if (note.id == id) {
                        notes.splice(i, 1);
                        return false;
                    }
                    return true; //every是true继续循环 false跳出
                });
            }
        </script>
    </div>

    <!-- new note -->

    <div class="container-newnote">
        <div class="lbl">
            <div class="tips-newnote">
                <label>Ctrl+Enter</label>
            </div>
            <label id="lbl-newnote">新建笔记</label>
            <!-- fold -->
            <div class="newnote-fold">
                <button class="br-btn btn-noback" id="btn-newnote-fold">
                    <i class="fa fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="control">
            <textarea id="note-text"></textarea>
        </div>
    </div>
    <div class="container-bottombar">
        <div class="trigger-mainmenu">
            <button class="br-btn btn-noback" id="btn-mainmenu-trigger">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <div class="trigger-expandnewnote">
            <button class="br-btn btn-noback" id="btn-newnote-expand">
                <i class="fa fa-chevron-up"></i>
            </button>
        </div>
    </div>

    <script>
        //绑定新建笔记的tooltip
        let tips_newnote_animplaying = false;
        $('#lbl-newnote').click(function () {
            if (!tips_newnote_animplaying) {
                $('.tips-newnote').css('display', 'block');
                tips_newnote_animplaying = true;
                $('.tips-newnote').animateCss('fadeIn', function () {
                    setTimeout(function () {
                        $('.tips-newnote').animateCss('fadeOut', function () {
                            $('.tips-newnote').css('display', 'none');
                            tips_newnote_animplaying = false;
                        });
                    }, 2000);
                });
            }
        });
        //折叠开关
        let isNoteFolded = false;
        //init
        storage.get('newnoteconfig', function (err, data) {
            if (err || typeof(data) == undefined || data == null || data == "") {
                isNoteFolded = false;
                $('.container-newnote').css('display', 'block');
                $('.trigger-expandnewnote').css('display', 'none');
            } else {
                if (data.isFolded) {
                    $('.container-newnote').animateCss('fadeOutDown', function () {
                        $('.container-newnote').css('display', 'none');
                        isNoteFolded = true;
                    });
                    $('.trigger-expandnewnote').css('display', 'block');
                    $('.trigger-expandnewnote').animateCss('fadeIn');
                } else {
                    isNoteFolded = false;
                    $('.container-newnote').css('display', 'block');
                    $('.trigger-expandnewnote').css('display', 'none');
                }
            }
        });
        //绑定折叠事件
        $('#btn-newnote-fold').click(function () {
            if (!isNoteFolded) {
                //set config
                var config = {
                    isFolded: true
                }
                storage.set('newnoteconfig', config);
                //animate
                $('.container-newnote').animateCss('fadeOutDown', function () {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                });
                $('.trigger-expandnewnote').css('display', 'block');
                $('.trigger-expandnewnote').animateCss('fadeIn');
            }
        });
        $('#btn-newnote-expand').click(function () {
            if (isNoteFolded) {
                //set config
                var config = {
                    isFolded: false
                }
                storage.set('newnoteconfig', config);
                //animate
                $('.container-newnote').css('display', 'block');
                $('.container-newnote').animateCss('fadeInUp');
                $('.trigger-expandnewnote').animateCss('fadeOut', function () {
                    $('.trigger-expandnewnote').css('display', 'none');
                    isNoteFolded = false;
                });
            }
        })
    </script>

    <!-- rightclick menu -->
    <div class="rightclickmenu">
        <div class="list-group">
            <button type="button" class="btn-rightclick list-group-item" id="btn-editNote" disabled>编辑</button>
            <button type="button" class="btn-rightclick list-group-item" id="btn-deleteNote">删除</button>
        </div>
    </div>

    <script>
        var noteid_clicked = -1;
        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    if (noteid_clicked != -1) {
                        $('#note_' + noteid_clicked).removeClass('note-selected');
                    }
                    $('.rightclickmenu').attr('style', 'display:block;' + 'left:' + e.clientX + 'px;top:' + e.clientY +
                        'px;z-index:1000;');
                    isRightClickMenuOpened = true;
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                    $(this).addClass('note-selected');
                }
            });
        }
        $('body').click(function (e) {
            $('.rightclickmenu').attr('style', 'display:none;'); //右键菜单隐藏
            $('#note_' + noteid_clicked).removeClass('note-selected');
            noteid_clicked = -1;
        });
        $('#note-list').scroll(function () {
            $('.rightclickmenu').attr('style', 'display:none;');
            $('#note_' + noteid_clicked).removeClass('note-selected');
            noteid_clicked = -1;
        });
    </script>

    <script>
        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
        require('../app/notes.js');
    </script>

    <!-- update -->
    <div class="container-updater">
        <div class="update-block">
            <div class="update-title">
                <span id="update-title-span">新版本已下载：</span>
            </div>
            <div class="update-contents">
                <h1 class="update-contents-title">更新日志</h1>
                <div class="update-contents-details">
                </div>
            </div>

            <div class="update-contents update-contents-loading">
                <span id="update-loading-span">载入中……</span>
            </div>

            <div class="update-footer">
                <div class="control-group" style="-webkit-user-select: none">
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-cancel">取消</button>
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-confirm">更新</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ipcRenderer -->
    <script>
        const {
            ipcRenderer
        } = require('electron');

        let time = require('../app/tools/time.js');
        ipcRenderer.on('message', (event, {
            message,
            data
        }) => {
            switch (message) {
                case 'checking-for-update':
                    console.log('checking for update...');
                    break;
                case 'update-available':
                    displayInfobar('update', '正在下载更新……');
                    break;
                case 'downloadProgress':
                    console.log('progress', data);
                    document.getElementById('update-progress').value = data.percent || 0;
                    document.getElementById('infobar-update-text').innerHTML = "正在下载更新（" + data.percent.toFixed(
                            1) || 0 +
                        "%）......";
                    break;
                case 'isUpdateNow':
                    console.log('isupdatenow');
                    document.getElementById('update-progress').value = 100;
                    document.getElementById('infobar-update-text').innerHTML = "新版本安装包已下载......";
                    $('.container-updater').css('display', 'block');
                    //收起上方的通知
                    $('#infobar_update').animateCss('fadeOutUp', function () {
                        $('#infobar_update').remove();
                    });
                    $('.container-updater').animateCss('fadeIn', function () {
                        $.getJSON(
                            `http://update.backrunner.top/fastnote/${process.platform}/var.json?time=` +
                            time.getRawCurrentMillTime(), //时间戳避免缓存
                            function (result) {
                                if (result != null && result != "" && typeof(result) != undefined) {
                                    try {
                                        $('#update-title-span').append(result.var);
                                        $('.update-contents-details').append(result.text);
                                        $('.update-contents-loading').css('display', 'none');

                                    } catch (err) {
                                        console.error(err);
                                        $('#update-loading-span').innerHTML = "更新日志加载失败";
                                    }
                                } else {
                                    $('#update-loading-span').innerHTML = "更新日志加载失败";
                                }
                            });
                    });
                case 'error':
                    //出现错误
                    if (typeof($('.container-updater').attr('style')) != undefined) {
                        if ($('.container-updater').attr('style').indexOf('block') != -1) {
                            $('.container-updater').animateCss('fadeOut', function () {
                                $('.container-updater').removeAttr('style');
                            });
                        }
                    }
                    //收起更新通知
                    $('#infobar_update').animateCss('fadeOutUp', function () {
                        $('#infobar_update').remove();
                    });
                    //显示错误通知
                    displayInfobar('error', '自动更新时出现错误......');
                    break;
            }
        });
        //绑定按钮事件
        $('#btn-update-cancel').on('click', function () {
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
        });
        $('#btn-update-confirm').on('click', function () {
            ipcRenderer.send('updateNow');
        })
    </script>

    <!-- main menu -->
    <div class="mainmenu-background"></div>
    <div class="container-mainmenu">
        <div class="mainmenu-panel">
            <div class="mainmenu-logo">
                <img src="images/logo.png"></img>
                <h1>Fastnote</h1>
                <span id="mainmenu-version"></span>
                <script>
                    //获取版本                    
                    var version = app.getVersion();
                    $(document).ready(function () {
                        console.log($('#mainmenu-version'));
                        $('#mainmenu-version').append(version);
                    });
                </script>
            </div>
            <div class="mainmenu-split"></div>
            <div class="mainmenu-menu">
                <ul>
                    <li>
                        <span>回收站</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-settings">
                        <span>设置</span>
                    </li>
                    <li id="mainmenu-btn-about">
                        <span>关于</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        //绑定主菜单的动画事件
        let isMainMenuOpen = false;
        $('.mainmenu-background').on('click', function () {
            if (isMainMenuOpen) {
                $('.mainmenu-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.mainmenu-background').animateCss('fadeOut', function () {
                    $('.mainmenu-background').css('display', 'none');
                })
                $('.container-mainmenu').animateCss('fadeOutLeft', function () {
                    $('.container-mainmenu').css('display', 'none');
                    isMainMenuOpen = false;
                })
            }
        });
        $('#btn-mainmenu-trigger').on('click', function () {
            if (!isMainMenuOpen) {
                $('.mainmenu-background').css('display', 'block');
                $('.mainmenu-background').css('width', '100%');
                $('.mainmenu-background').animateCss('fadeIn', function () {
                    $('.mainmenu-background').css('width', '80%');
                });
                $('.container-mainmenu').css('display', 'block');
                $('.container-mainmenu').animateCss('fadeInLeft');
                isMainMenuOpen = true;
            }
        });
        //绑定菜单项
        $('#mainmenu-btn-about').click(function(){
            ipcRenderer.send("openAboutWindow");
        });
    </script>
</body>

</html>