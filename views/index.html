<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('../node_modules/jquery/dist/jquery.min.js');
        require('../node_modules/bootstrap/dist/js/bootstrap.min.js');
    </script>
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../node_modules/animate.css/animate.min.css">
    <script src="js/han.simple.js"></script>
    <script src="js/notes.render.js"></script>
    <script>
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        const storage = require('electron-json-storage');

        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;

        const {
            ipcRenderer
        } = require('electron');

        const notesEdit = require("../app/notes_edit.js");

        //tools
        const UUID = require('../app/tools/uuid.js');
        const indebug = remote.getGlobal('indebug');

        //import menu
        $.getScript('js/menu.note.js');
        $.getScript('js/menu.textarea.js');

        var settings;

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
        });

        function settingsInit(settings) {
            var cssText = "";
            //build css
            if (settings == null) {
                //read error
                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                cssText += '.note-content p {text-align:justify;}'; //note text align
            } else {
                //read success
                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}';
                }
                if (typeof settings.notealign != 'undefined') {
                    cssText += '.note-content p {text-align:' + settings.notealign + ';}'; //note text align
                } else {
                    cssText += '.note-content p {text-align:justify;}';
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;
        }
    </script>

    <script>
        //获取版本
        var version = app.getVersion();

        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });

        //first start
        var uuid = "";
        var firstStart = false;
        //生成一个独立的uuid
        storage.has('uuid', function (error, hasKey) {
            if (error) {
                console.error(error);
                throw (error);
            }
            //err为首次启动
            if (hasKey) {
                storage.get('uuid', function (error, data) {
                    if (error) {
                        console.error(error);
                        throw (error);
                    } else {
                        if (typeof data != 'undefined'){
                            uuid = data.uuid;
                            installstat(uuid);
                            ipcRenderer.send("set-uuid", uuid);
                        }
                    }
                });
            } else {
                uuid = UUID.gen();
                var json = {
                    uuid: uuid
                }
                storage.set('uuid', json);
                firstStart = true;
                installstat(uuid);
                ipcRenderer.send("set-uuid", uuid);
                addTiptoEmptyInfo();
            }
        });

        function installstat(uuid) {
            //异步调用安装量统计
            if (!indebug) {
                $.ajax({
                    url: 'https://test.backrunner.top/projects/installstat/api/submit.php',
                    type: 'POST',
                    data: 'projectid=1&uuid=' + uuid + '&version=' + version,
                    dataType: 'JSON',
                    success: function (data) {
                        if (data.status == "success") {
                            console.log("InstallStat: Success, " + data.msg);
                        } else {
                            console.warn("InstallStat: Error, " + data.msg);
                        }
                    },
                    error: function (data) {
                        console.error("InstallStat: Error");
                        console.error(data);
                    },
                    timeout: 5000
                });
            } else {
                $.ajax({
                    url: 'http://localhost/projects/installstat/api/submit.php',
                    type: 'POST',
                    data: 'projectid=1&uuid=' + uuid + '&version=' + version,
                    dataType: 'JSON',
                    success: function (data) {
                        if (data.status == "success") {
                            console.log("InstallStat: Success, " + data.msg);
                        } else {
                            console.warn("InstallStat: Error, " + data.msg);
                        }
                    },
                    error: function (data) {
                        console.error("InstallStat: Error");
                        console.error(data);
                    },
                    timeout: 5000
                });
            }
        }
    </script>
</head>

<body>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">Fastnote</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- notes -->
    <div class="container-main">
        <div class="note-list" id="note-list"></div>
        <!-- empty -->
        <div class="note-empty col-lg-12" id="note-empty">
            <span>您还没有建立任何的笔记</br>在下方你可以快速新建新笔记</span>
        </div>
        <script>
            //编辑笔记
            ipcRenderer.on('update-edit-note', (event, data) => {
                updateEditNote(data);
            });

            function updateEditNote(note) {
                notesEdit.saveEditNote(note, function (data) {
                    updateEditNoteinArray(data); //更新数组内容
                    //reset contents in note
                    temp = data.text.split('<br/>');
                    text = "";
                    for (var i = 0; i < temp.length; i++) {
                        s = $("#filter-x").text(temp[i]).html().replace(' ', '&nbsp;');
                        text += s;
                        text += "<br/>";
                    }
                    final_text = insert_spacing(text, 0.12);
                    var html = final_text.replace(reg_url, function (result) {
                        return '<a href="' + result + '">' + result + '</a>';
                    });
                    var origin_height = $('#note_' + data.id + ' .note-content').height(); //get origin height
                    //reset note content on page
                    $("#note_" + data.id + " .note-content p").html(html);
                    $('#note_' + data.id + ' .note-content').removeClass('note-overheight');
                    $('#note_' + data.id + ' .note-content').removeAttr('style');
                    var after_height = $('#note_' + data.id + ' .note-content').height();
                    //reset content of updatetime
                    var timeContent = '<p class="note-time note-updatetime han-element">更新：' +
                        data.updatetime +
                        '</p>' +
                        '<p class="note-time han-element">创建：' + data.time + '</p>';
                    $('#note_' + data.id + ' .note-header time').html(timeContent);
                    //open external event rebind
                    $('#note_' + data.id + ' a').click(function (e) {
                        ipcRenderer.send('openExternalURL', $(this).attr('href'));
                        e.preventDefault();
                    });
                    //show infobar
                    displayInfobar("success", "笔记内容已保存");

                    var tag_class = $('#note_' + data.id + ' .note-content').attr('class');
                    //fix note status
                    if (after_height >= 250) {
                        if (origin_height <= 250) {
                            bindNoteFoldDBL(data.id);
                            $('#note_' + data.id + ' .note-content').css('height', origin_height);
                            $('#note_' + data.id + ' .note-content').animate({
                                height: "250px"
                            });
                        } else {
                            //already expanded
                            $('#note_' + data.id + ' .note-content').css('height', origin_height);
                            $('#note_' + data.id + ' .note-content').animate({
                                height: after_height
                            });
                        }
                    } else {
                        $('#note_' + data.id + ' .note-content').css('height', origin_height);
                        $('#note_' + data.id + ' .note-content').animate({
                            height: after_height
                        });
                        $('#note_' + data.id + ' .note-content').dblclick = function () {}; //unbind event
                        $('#note_' + data.id + ' .note-content').unbind('dblclick');
                    }
                });
            }

            //异步执行notes的替换
            async function updateEditNoteinArray(data) {
                for (var i = 0; i < notes.length; i++) {
                    if (notes[i].id == data.id) {
                        notes[i] = data;
                        return;
                    }
                }
            }

            //first start - tooltip
            function addTiptoEmptyInfo() {
                //首次启动在note-empty显示提示
                if (firstStart) {
                    $('.note-empty span').append('<br/>'+insert_spacing('(请使用Ctrl+Enter保存新建笔记)',0.15));
                }
            }

            //event restore
            ipcRenderer.on('restore-note', (event, data) => {
                if (notes.length <= 0) {
                    showNoteList();
                }
                addNoteObjToArray(data);
                refreshNoteList(function () {
                    bindNoteFoldDBL(data.id);
                });
                //animate
                $('#note_' + data.id).animateCss('fadeInLeft');
            });
        </script>
    </div>

    <!-- new note -->

    <div class="container-newnote">
        <div class="lbl">
            <label id="lbl-newnote" title="使用 Ctrl+Enter 提交便签">新建便签</label>
            <!-- fold -->
            <div class="newnote-fold">
                <button class="br-btn btn-noback" id="btn-newnote-fold">
                    <i class="fa fa-chevron-down"></i>
                </button>
            </div>
        </div>
        <div class="control">
            <textarea id="note-text"></textarea>
        </div>
    </div>
    <div class="container-bottombar">
        <div class="trigger-mainmenu">
            <button class="br-btn btn-noback" id="btn-mainmenu-trigger">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <div class="trigger-expandnewnote">
            <button class="br-btn btn-noback" id="btn-newnote-expand">
                <i class="fa fa-chevron-up"></i>
            </button>
        </div>
        <div class="bottom-bar-statusbar" id="statusbar">
        </div>
    </div>

    <script>
        //折叠开关
        let isNoteFolded = false;
        //init
        storage.get('newnoteconfig', function (err, data) {
            if (err || typeof (data) == 'undefined' || data == null || data == "") {
                isNoteFolded = false;
                $('.container-newnote').css('display', 'block');
                $('.trigger-expandnewnote').css('display', 'none');
                setTimeout(function(){
                    $('.note-list').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                    $('.note-empty').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                },200);
            } else {
                if (data.isFolded) {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                    $('.trigger-expandnewnote').css('display', 'block');
                    //late execute
                    setTimeout(function(){
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar').height() - 27);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar').height() - 27);
                    },200);
                } else {
                    isNoteFolded = false;
                    $('.container-newnote').css('display', 'block');
                    $('.trigger-expandnewnote').css('display', 'none');
                    setTimeout(function(){
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                    },200);
                }
            }

        });
        //绑定折叠事件
        $('#btn-newnote-fold').click(function () {
            if (!isNoteFolded) {
                //set config
                var config = {
                    isFolded: true
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                //animate
                $('.container-newnote').animateCss('fadeOutDown', function () {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                });
                $('.trigger-expandnewnote').css('display', 'block');
                $('.trigger-expandnewnote').animateCss('fadeIn');
            }
        });
        $('#btn-newnote-expand').click(function () {
            if (isNoteFolded) {
                //set config
                var config = {
                    isFolded: false
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                //animate
                $('.container-newnote').css('display', 'block');
                $('.container-newnote').animateCss('fadeInUp');
                $('.trigger-expandnewnote').animateCss('fadeOut', function () {
                    $('.trigger-expandnewnote').css('display', 'none');
                    isNoteFolded = false;
                });
            }
        });
    </script>

    <!-- import clipboard operation-->
    <script src='js/clipboard.copy.js'></script>

    <script>
        var noteid_clicked = -1;

        //右键菜单相关事件绑定
        function bindRightClickEvent() {
            $('.note').mousedown(function (e) {
                if (e.which == 3) {
                    if (noteid_clicked != -1) {
                        $('#note_' + noteid_clicked).parent().removeClass('note-selected');
                    }
                    noteid_clicked = parseInt($(this).attr("id").replace('note_', ''));
                    $(this).parent().addClass('note-selected');
                    menu_note.popup(remote.getCurrentWindow());
                }
            });
            $('#note-text').mousedown(function (e) {
                if (e.which == 3) {
                    if ($('#note-text').val().trim().length>0){
                        if (getSelectText('note-text').length>0){
                            menu_textarea_selected.popup(remote.getCurrentWindow());
                        } else {
                            menu_textarea.popup(remote.getCurrentWindow());
                        }
                    } else {
                        menu_textarea_empty.popup(remote.getCurrentWindow());
                    }
                }
            });
        }

        function getSelectText(id) {
            var t = document.getElementById(id);
            if (window.getSelection) {
                if (t.selectionStart != undefined && t.selectionEnd != undefined) {
                    return t.value.substring(t.selectionStart, t.selectionEnd);
                } else {
                    return "";
                }
            } else {
                return document.selection.createRange().text;
            }
        }
    </script>

    <!-- update -->
    <div class="container-updater">
        <div class="update-block">
            <div class="update-title">
                <span id="update-title-span">检测到新版本：</span>
            </div>
            <div class="update-contents">
                <h1 class="update-contents-title">更新日志</h1>
                <div class="update-contents-details">
                </div>
            </div>

            <div class="update-contents update-contents-loading">
                <span id="update-loading-span">载入中……</span>
            </div>

            <div class="update-footer">
                <div class="control-group" style="-webkit-user-select: none">
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-cancel">取消</button>
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-confirm">下载</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ipcRenderer -->
    <script>
        let time = require('../app/tools/time.js');
        ipcRenderer.on('message', (event, {
            message,
            data
        }) => {
            switch (message) {
                case 'checking-for-update':
                    console.log('checking for update...');
                    break;
                case 'update-available':
                    console.log("update-avaliable");
                    $('.container-updater').css('display', 'block');
                    $('.container-updater').animateCss('fadeIn', function () {
                        var path_varfile =
                            `http://update.backrunner.top/fastnote/${process.platform}/var.json?time=`;
                        $.getJSON(path_varfile + time.getRawCurrentMillTime(), //时间戳避免缓存
                            function (result) {
                                if (result != null && result != "" && typeof (result) !=
                                    'undefined') {
                                    try {
                                        $('#update-title-span').text('检测到新版本：' + result.var);
                                        document.getElementsByClassName('update-contents-details')[
                                            0].innerHTML = result.text;
                                        //check show full
                                        if (result.showfull) {
                                            document.getElementsByClassName(
                                                    'update-contents-details')[
                                                    0].innerHTML +=
                                                '<a class="update-contents-showfull" href="https://io.backrunner.top/2018/07/08/Fastnote%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97.html">完整更新日志</a>'
                                        }
                                        $('.update-contents-loading').css('display', 'none');
                                    } catch (err) {
                                        console.error(err);
                                        $('#update-loading-span').innerHTML = "更新日志加载失败";
                                    }
                                } else {
                                    $('#update-loading-span').innerHTML = "更新日志加载失败";
                                }
                            });
                    });
                    break;
                case 'downloadProgress':
                    document.getElementById('update-progress').value = data.percent;
                    document.getElementById('infobar-update-text').innerText = "正在下载更新（" + data.percent.toFixed(
                        1) + " %）......";
                    break;
                case 'update-downloaded':
                    console.log('update-downloaded');
                    //收起上方的通知
                    $('#infobar_update').animateCss('fadeOutUp', function () {
                        $('#infobar_update').remove();
                    });
                    displayInfobar('success', '更新下载完成，关闭程序后将自动安装', 5000);
                    $('#statusbar').append(
                        '<div class="statusbar-item" title="更新下载完毕，重启后安装"><i class="fa fa-arrow-circle-up"></i></div>'
                    );
                case 'error':
                    console.error(data);
                    break;
            }
        });
        //绑定按钮事件
        $('#btn-update-cancel').on('click', function () {
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
            ipcRenderer.send('updateCancelled');
        });
        $('#btn-update-confirm').on('click', function () {
            ipcRenderer.send('downloadNow');
            displayInfobar('update', '正在下载更新……');
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
        })
    </script>

    <!-- main menu -->
    <div class="mainmenu-background"></div>
    <div class="container-mainmenu">
        <div class="mainmenu-panel">
            <div class="mainmenu-logo">
                <img src="images/logo.png" />
                <h1>Fastnote</h1>
                <span id="mainmenu-version"></span>
                <script>
                    $(document).ready(function () {
                        $('#mainmenu-version').text(version);
                    });
                </script>
            </div>
            <div class="mainmenu-split"></div>
            <div class="mainmenu-menu">
                <ul>
                    <li id="mainmenu-btn-recycle">
                        <span>回收站</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-settings">
                        <span>设置</span>
                    </li>
                    <li id="mainmenu-btn-about">
                        <span>关于</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-reload">
                        <span>重新载入</span>
                    </li>
                    <li id="mainmenu-btn-exit">
                        <span>退出</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        //绑定主菜单的动画事件
        let isMainMenuOpen = false;
        $('.mainmenu-background').on('click', function () {
            closeMainMenu();
        });
        $('#btn-mainmenu-trigger').on('click', function () {
            if (!isMainMenuOpen) {
                $('.mainmenu-background').css('display', 'block');
                $('.mainmenu-background').animateCss('fadeIn');
                $('.container-mainmenu').css('display', 'block');
                $('.container-mainmenu').animateCss('fadeInLeft');
                isMainMenuOpen = true;
            }
        });
        //绑定菜单项
        $('#mainmenu-btn-recycle').click(function () {
            ipcRenderer.send("openRecycleWindow");
            closeMainMenu();
        });
        $('#mainmenu-btn-settings').click(function () {
            ipcRenderer.send("openSettingsWindow"); //打开关于窗口
            closeMainMenu();
        });
        $('#mainmenu-btn-about').click(function () {
            ipcRenderer.send("openAboutWindow"); //打开关于窗口
            closeMainMenu();
        });
        $('#mainmenu-btn-reload').click(function () {
            ipcRenderer.send("reloadMainWindow"); //退出程序
            closeMainMenu();
        });
        $('#mainmenu-btn-exit').click(function () {
            ipcRenderer.send("app-quitNow"); //退出程序
            closeMainMenu();
        });

        function closeMainMenu() {
            if (isMainMenuOpen) {
                $('.mainmenu-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.mainmenu-background').animateCss('fadeOut', function () {
                    $('.mainmenu-background').css('display', 'none');
                })
                $('.container-mainmenu').animateCss('fadeOutLeft', function () {
                    $('.container-mainmenu').css('display', 'none');
                    isMainMenuOpen = false;
                })
            }
        }

        //bind resize
        $(window).resize(function () { //当浏览器大小变化时
            var windowHeight = $(window).height();
            //调整list的高度
            var listHeight = 0;
            if ($('.container-newnote').css('display') == 'none') {
                listHeight = $(window).height() - $('.container-titlebar').height() - 27;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            } else {
                listHeight = $(window).height() - $('.container-titlebar').height() - 207;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            }
            //调整note的高度
            $('.note-content').each(function () {
                if ($(this).attr('class').indexOf('note-overheight') == -1) {
                    $(this).css('height', 'auto');
                }
            });
        });
    </script>

    <script>
        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
        $.getScript('../app/notes.js');
    </script>

    <span id="filter-x" style="display:none"></span>
</body>

</html>