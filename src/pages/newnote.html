<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新建便签</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('./static/jquery.min.js');
        require('./static/bootstrap.min.js');
    </script>

    <link rel="stylesheet" id="main-style" type="text/css" media="screen" href="static/main.white.css">
    <link rel="stylesheet" href="static/font-awesome.min.css">
    <link rel="stylesheet" href="static/bootstrap.min.css">
    <link rel="stylesheet" href="static/animate.min.css">
    <script src="static/encryption.js"></script>
    <script src="static/han.simple.js"></script>
    <script>
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        var fs = require('fs');
        //import json storage
        const storage = require('electron-json-storage');
        //get storagePath
        var storagePath = app.getPath('userData');

        //ipc
        const {
            ipcRenderer
        } = require('electron');

        //获取indebug
        global.indebug = remote.getGlobal('indebug');

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
            $(document).ready(function () {
                ipcRenderer.send("newnote-window-ready");
            });
        });

        function settingsInit(settings) {
            var cssText = "";
            var font = "";
            //build css
            if (settings == null) {
                //read error
                $('#main-style').attr('href', 'static/main.blackwhite.css');
                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                font = 'Source Han Sans CN';

                console.error('A error occured when reading settings.');
            } else {
                //read success
                if (typeof settings.theme != 'undefined') {
                    $('#main-style').attr('href', 'static/main.' + settings.theme + '.css');
                } else {
                    $('#main-style').attr('href', 'static/main.blackwhite.css');
                }

                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                    font = settings.fontfamily;
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;';
                    font = 'Source Han Sans CN';
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            if (font == 'Source Han Sans CN') {
                loadWebfont(font);
            }
        }

        function loadWebfont(font) {
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }

        //init category
        ipcRenderer.on('init-category', (sender, data) => {
            if (data != 'notalloc') {
                $(document).ready(function () {
                    $('#select-category').val(data);
                });
            }
        });
    </script>
</head>

<body class="newnote-body">
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="newnote-title">新建便签</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <div class="container-lockscreen">
        <div class="lockscreen">
            <div class="lockscreen-icon">
                <i class="fa fa-lock" aria-hidden="true"></i>
            </div>
            <div class="lockscreen-form">
                <input type="password" class="brcontrol-input" id="input-lockscreen">
            </div>
        </div>
    </div>
    <script src="static/lockscreen.js"></script>
    <!-- main -->
    <div class="container-newnotewin">
        <div class="container-newnotewin-info">
            <div class="edit-info-item">
                <label>标题</label>
                <div class="newnotewin-item-control">
                    <input class="form-control" id="input-title" maxlength="64" placeholder="(无标题)">
                </div>
            </div>
            <div style="margin-top: 8px;">
                <div class="edit-info-item edit-info-item-half edit-info-inlineitem">
                    <label>分类</label>
                    <div class="newnotewin-item-control-half-left">
                        <select class="form-control" id="select-category">
                            <option value="notalloc">未分类</option>
                        </select>
                    </div>
                </div>
                <div class="edit-info-item edit-info-item-half edit-info-inlineitem">
                    <label>密码</label>
                    <div class="newnotewin-item-control-half-right">
                        <input class="form-control" id="input-password" type="password" placeholder="(未设置)">
                    </div>
                </div>
            </div>
        </div>
        <script>
            if (fs.existsSync(storagePath + (global.indebug ? '/devTemp' : '') + '/storage/categories.json')) {
                var read_res = fs.readFileSync(storagePath + (global.indebug ? '/devTemp' : '') + '/storage/categories.json', 'utf-8'); //这里有同步让后面的update可以选择
                if (read_res) {
                    categories = JSON.parse(read_res);
                    for (var i = 0; i < categories.length; i++) {
                        $('#select-category').append('<option value="' + categories[i].name + '">' + categories[i].name + '</option>');
                    }
                } else {
                    console.error(read_res);
                }
            }
            ipcRenderer.on('category-added', (sender, data) => {
                $('#select-category').append('<option value="' + data + '">' + data + '</option>');
            });
            ipcRenderer.on('category-removed', (sender, data) => {
                $('#select-category option[value="' + data + '"]').remove();
            });
        </script>
        <div class="container-newnotewin-text">
            <textarea class="text-newnote" id="text-newnote"></textarea>
        </div>
        <div class="container-newnotewin-button">
            <button class="br-btn btn-noback" id="newnote-btn-save" onclick="submitSave();">保存</button>
        </div>
        <script>
            $(window).resize(function () {
                resizeContent();
            });

            function resizeContent() {
                //设置控件的宽度
                $('.newnotewin-item-control').css('width', $(window).width() - 76);
                $('.newnotewin-item-control-half-left').css('width', ($(window).width() - 32) / 2 - 62);
                $('.newnotewin-item-control-half-right').css('width', ($(window).width() - 32) / 2 - 44);
                //设置文本域的高度
                var h_container = $(window).height() - $('.container-titlebar').height();
                $('.container-newnotewin').css('height', h_container);
                var h_textedit = h_container - $('.container-newnotewin-info').height() - 71;
                $('#text-newnote').css('height', h_textedit);
            }

            //事件绑定
            $("#text-newnote").keydown(function (e) {
                var ctrlKey = e.ctrlKey || e.metaKey;
                //ctrl+enter 或 ctrl+s
                if (ctrlKey && e.keyCode == 13 || ctrlKey && e.keyCode == 83) {
                    submitSave();
                }
            });

            //提交保存
            function submitSave() {
                //获取title和分类
                var title = $('#input-title').val().trim();
                var category = $('#select-category').val();
                if (title.length < 1) {
                    title = undefined;
                }
                if (category == 'notalloc') {
                    category = undefined;
                }
                var text = $('#text-newnote').val();
                var note = {
                    title: title,
                    category: category,
                    text: text
                };
                ipcRenderer.send('newnotewin-save', note);
                //关闭窗口
                window.close();
            }
        </script>
    </div>
</body>