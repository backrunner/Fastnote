<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>编辑</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('./static/jquery.min.js');
        require('./static/bootstrap.min.js');
    </script>
    <link rel="stylesheet" id="main-style" type="text/css" media="screen" href="static/main.white.css" />
    <link rel="stylesheet" href="static/font-awesome.min.css">
    <link rel="stylesheet" href="static/bootstrap.min.css">
    <link rel="stylesheet" href="static/animate.min.css">
    <script src="static/han.simple.js"></script>
    <script src="static/mousetrap.min.js"></script>
    <script>
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        var fs = require('fs');
        //import json storage
        const storage = require('electron-json-storage');
        //get storagePath
        var storagePath = app.getPath('userData');

        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;

        //crypto
        const crypto = require('crypto');

        //ipc
        const {
            ipcRenderer
        } = require('electron');

        const WebFont = require('webfontloader');

        //获取indebug
        global.indebug = remote.getGlobal('indebug');

        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery

        //import menu
        $.getScript('static/menu.textarea.js');

        var settings;

        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
            $(document).ready(function(){
                ipcRenderer.send("edit-window-ready");
            });
        });

        function settingsInit(settings) {
            var cssText = "";
            var font = "";
            //build css
            if (settings == null) {
                //read error
                $('#main-style').attr('href','static/main.blackwhite.css');
                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                font = 'Source Han Sans CN';

                console.error('A error occured when reading settings.');
            } else {
                //read success
                if (typeof settings.theme != 'undefined'){
                    $('#main-style').attr('href','static/main.'+settings.theme+'.css');
                } else {
                    $('#main-style').attr('href','static/main.blackwhite.css');
                }

                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                    font = settings.fontfamily;
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;';
                    font = 'Source Han Sans CN';
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            if (font == 'Source Han Sans CN'){
                loadWebfont(font);
            }
        }

        function loadWebfont(font){
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }
    </script>
</head>

<body>
    <script>
        //全局变量定义
        var note;
    </script>
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title edit-title" id="edit-title">编辑笔记</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 999;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <div class="container-lockscreen">
        <div class="lockscreen">
            <div class="lockscreen-icon">
                <i class="fa fa-lock" aria-hidden="true"></i>
            </div>
            <div class="lockscreen-form">
                <input type="password" class="brcontrol-input" id="input-lockscreen">
            </div>
        </div>
    </div>
    <script src="static/lockscreen.js"></script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- main -->
    <div class="container-edit">
        <div class="container-edit-header">
            <span id="edit-header-time"></span>
        </div>
        <div class="container-edit-info">
            <div class="edit-info-item">
                <div class="br-col-1">
                    <label>标题</label>
                </div>
                <div class="br-col-11">
                    <input class="form-control" id="input-title" maxlength="64" placeholder="(无标题)">
                </div>
            </div>
            <div class="edit-info-item" style="margin-top: 8px;">
                <div class="br-col-1">
                    <label>分类</label>
                </div>
                <div class="br-col-11">
                    <select class="form-control" id="select-category">
                        <option value="notalloc">未分类</option>
                    </select>
                </div>
                <script>
                    if(fs.existsSync(storagePath + (global.indebug?'/devTemp':'')+ '/storage/categories.json')){
                        var read_res = fs.readFileSync(storagePath + (global.indebug?'/devTemp':'')+ '/storage/categories.json', 'utf-8');  //这里有同步让后面的update可以选择
                        if (read_res){
                            categories = JSON.parse(read_res);
                            for (var i=0;i<categories.length;i++){
                                $('#select-category').append('<option value="'+categories[i].name+'">'+categories[i].name+'</option>');
                            }
                        } else {
                            console.error(read_res);
                        }
                    }
                </script>
            </div>
        </div>
        <textarea class="text-edit" id="text-edit"></textarea>
    </div>
    <div class="container-footer">
        <div class="control-group">
            <button class="br-btn btn-noback" id="edit-btn-save">保存</button>
            <button class="br-btn btn-noback" id="edit-btn-cancel">取消</button>
        </div>
    </div>
    <script>
        var nowNoteId = 0;
        var text_edited = false;

        //文本是否编辑过
        $("#text-edit").one('input',function(){
            text_edited = true;
        });

        $("#input-title").one('input',function(){
            text_edited = true;
        });
        $('#select-category').one('change',function(){
            text_edited = true;
        });
        //footer按钮事件绑定
        $("#edit-btn-save").click(function () {
            submitSave();
        });

        $("#edit-btn-cancel").click(function () {
            window.close();
        });

        var isComboKey = false;
        Mousetrap.bind(['ctrl+s','ctrl+enter'],function(){
            submitSave();
            return false;
        });

        $("#text-edit").keydown(function (e) {
            var ctrlKey = e.ctrlKey || e.metaKey;
            //ctrl+enter 或 ctrl+s
            if (ctrlKey && e.keyCode == 13 || ctrlKey && e.keyCode == 83) {
                submitSave();
            }
        });

        $("#input-title").keydown(function (e) {
            var ctrlKey = e.ctrlKey || e.metaKey;
            //ctrl+enter 或 ctrl+s
            if (ctrlKey && e.keyCode == 13 || ctrlKey && e.keyCode == 83) {
                submitSave();
            }
        });

        function submitSave(){
            var text = $("#text-edit").val().trim();
            var title = $('#input-title').val().trim();
            var category = $('#select-category').val();
            if (text != null && text != "") {
                if (text_edited){
                    note.text = text;
                    if (title.length > 0){
                        note.title = title;
                    } else {
                        note.title = undefined;
                    }
                    //修改分类
                    note.category = category;
                    ipcRenderer.send('update-edit-note', note);
                }
                window.close();
            } else {
                //error
                displayInfobar("error", "笔记内容不能为空");
            }
        }

        ipcRenderer.on('message', (event, {
            type,
            data
        }) => {
            switch (type) {
                case 'init':
                    note = data;
                    nowNoteId = note.id;
                    //初始化textarea
                    $("#text-edit").text(note.text);
                    //初始化title
                    $("#edit-title").append(" #" + note.id);
                    $("title").append(" - #" + note.id);
                    //初始化header
                    if (typeof note.updatetime == 'undefined'){
                        $("#edit-header-time").append('创建时间：'+note.time);
                    } else {
                        $("#edit-header-time").append('最近一次编辑：'+note.updatetime);
                    }
                    //初始化title
                    if (typeof note.title != 'undefined'){
                        if (note.title.length>20){
                            var t = note.title.substring(0,20)+'...';
                            $("#edit-title").append(' '+t);
                            $("title").append(' '+t);
                        } else {
                            $("#edit-title").append(' '+note.title);
                            $("title").append(' '+note.title);
                        }
                        if (note.title.length > 0){
                            $('#input-title').val(note.title);
                        }
                    }
                    //初始化分类
                    $(document).ready(function(){
                        if (typeof note.category != 'undefined'){
                            $('#select-category').val(note.category);
                        } else {
                            $('#select-category').val('notalloc');
                        }
                    });
                    break;
                case 'note-recycled':
                    if (data.id == nowNoteId){
                        window.close();
                    }
                    break;
                case 'category-added':
                    $('#select-category').append('<option value="'+data+'">'+data+'</option>');
                    break;
                case 'category-removed':
                    $('#select-category option[value="'+data+'"]').remove();
                    break;
                default:
                    console.log('unknown message:'+type);
                    break;
            }
        });

        ipcRenderer.on('readyToReload', function(sender, data){
            ipcRenderer.send('readyToReloadEditWindow', note);
        });

        //窗口大小变化
        $(window).resize(function () {
            resizeContent();
        });
        function resizeContent(){
            var h_container = $(window).height() - $('.container-titlebar').height() - 48;
            $('.container-edit').css('height', h_container);
            var h_textedit = h_container - $('.container-edit-header').height() - $('.container-edit-info').height() - 39;
            $('#text-edit').css('height', h_textedit);
        }

        //右键菜单相关事件绑定
        $('#text-edit').mousedown(function (e) {
            if (e.which == 3) {
                if ($('#text-edit').val().trim().length > 0) {
                    if (getSelectText('text-edit').length > 0) {
                        popup_menu_textarea_selected();
                    } else {
                        popup_menu_textarea();
                    }
                } else {
                    popup_menu_textarea_empty();
                }
            }
        });

        function getSelectText(id) {
            var t = document.getElementById(id);
            if (window.getSelection) {
                if (t.selectionStart != undefined && t.selectionEnd != undefined) {
                    return t.value.substring(t.selectionStart, t.selectionEnd);
                } else {
                    return "";
                }
            } else {
                return document.selection.createRange().text;
            }
        }
    </script>
</body>