<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('./static/jquery.min.js');
    </script>

    <link rel="stylesheet" id="main-style" type="text/css" media="screen" href="static/main.white.css">
    <link rel="stylesheet" href="static/font-awesome.min.css">
    <link rel="stylesheet" href="static/bootstrap.min.css">
    <link rel="stylesheet" href="static/animate.min.css">
    <script src="static/array.js"></script>
    <script src="static/i18n.js"></script>
    <script src="static/i18n/render.js"></script>
    <script src="static/encryption.js"></script>
    <script src="static/han.simple.js"></script>
    <script src="static/category.js"></script>
    <script src="static/bootstrap.min.js"></script>
    <script src="static/mousetrap.min.js"></script>
    <script src="static/moment.min.js"></script>
    <script src="static/html5sortable.min.js"></script>
    <script src="static/notes.render.js"></script>
    <script>
        //i18n
        var postprocess_i18n = [{
            selector: '#input-note-title',
            attr: 'placeholder',
            key: 'placeholder_notitle'
        }, {
            selector: '#input-note-password',
            attr: 'placeholder',
            key: 'placeholder_notsetpassword'
        }];
        var postprocess_i18n_css = [{
            selector: '.newnote-info-item',
            class: 'newnote-info-item-en-us'
        }];
    </script>
    <script>
        //define const
        var remote = require('electron').remote;
        var app = remote.app;
        //import json storage
        if (typeof storage != 'undefined') {
            var storage = require('electron-json-storage');
        }

        //dialog
        const {
            dialog
        } = require('electron').remote;

        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;

        const {
            ipcRenderer
        } = require('electron');

        const notesEdit = require("../app/notes_edit.js");

        //tools
        const UUID = require('../app/tools/uuid.js');
        const indebug = remote.getGlobal('indebug');

        //初始化Fastnote cloud
        const cloudConfig = require('../app/cloud/config.js');
        if (indebug) {
            var cloud_protocol = cloudConfig.dev.protocol;
            var cloud_host = cloudConfig.dev.host;
            var cloud_port = cloudConfig.dev.port;
            var cloud_apibase = cloudConfig.dev.protocol + '://' + cloudConfig.dev.host + ':' + cloudConfig.dev.port
        } else {
            var cloud_protocol = cloudConfig.release.protocol;
            var cloud_host = cloudConfig.release.host;
            var cloud_port = cloudConfig.release.port;
            var cloud_apibase = cloudConfig.release.protocol + '://' + cloudConfig.release.host + ':' + cloudConfig.release.port
        }

        const WebFont = require('webfontloader');

        //import menu
        $.getScript('static/menu.note.js');
        $.getScript('static/menu.textarea.js');

        //设置项
        var settings;

        storage.get('settings', function(error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
            //设置加载完成，显示窗体
            $(document).ready(function() {
                ipcRenderer.send("main-window-ready");
            });
        });

        function settingsInit(settings) {
            var cssText = "";
            var font = "";
            //build css
            if (settings == null) {
                //read error
                $('#main-style').attr('href', 'static/main.blackwhite.css');

                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                font = 'Source Han Sans CN';
                current_i18n = 'zh-cn';
                $.getScript('static/i18n/zh-cn.js');

                console.error('A error occured when reading settings.');
            } else {
                //初始化语言
                if (typeof settings.language != 'undefined') {
                    if (settings.language != 'zh-cn') {
                        $(document).ready(function() {
                            applyLanguage(settings.language);
                        });
                    } else {
                        $.getScript('static/i18n/zh-cn.js');
                    }
                    current_i18n = settings.language;
                } else {
                    current_i18n = 'zh-cn';
                    $.getScript('static/i18n/zh-cn.js');
                }
                //优先初始化锁屏
                if (typeof settings.lockpassword != 'undefined') {
                    $('.container-lockscreen').css('display', 'block');
                    $('#input-lockscreen').focus();
                }
                //read success
                if (typeof settings.theme != 'undefined') {
                    $('#main-style').attr('href', 'static/main.' + settings.theme + '.css');
                } else {
                    $('#main-style').attr('href', 'static/main.blackwhite.css');
                }

                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                    font = settings.fontfamily;
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;';
                    font = 'Source Han Sans CN';
                }

                //笔记显示设置初始化
                cssText += '.note-content p, .note-content span{';
                if (typeof settings.fontsize != 'undefined') {
                    cssText += 'font-size:' + settings.fontsize + 'px !important;';
                }
                if (typeof settings.lineheight != 'undefined') {
                    cssText += 'line-height:' + settings.lineheight + 'px !important;';
                }
                if (typeof settings.textalign != 'undefined') {
                    cssText += 'text-align:' + settings.textalign + ' !important;'; //note text align
                }
                if (typeof settings.letterspacing != 'undefined') {
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'

                cssText += '.note-content a{';
                if (typeof settings.fontsize != 'undefined') {
                    cssText += 'font-size:' + settings.fontsize + 'px !important;';
                }
                if (typeof settings.letterspacing != 'undefined') {
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'

                //日期显示初始化
                if (typeof settings.datedisplay != 'undefined') {
                    switch (settings.datedisplay) {
                        case 'createonly':
                            cssText += '.note-updatetime {display:none !important;}';
                            cssText += '.note-createtime-label {display:none !important;}';
                            break;
                        case 'updateonly':
                            cssText += '.note-createtime {display:none !important;}';
                            cssText += '.note-updatetime-label {display:none !important;}';
                            break;
                        case 'none':
                            cssText += 'time {display:none !important;}';
                            break;
                    }
                }

                //时间显示初始化
                if (typeof settings.timedisplay != 'undefined') {
                    switch (settings.timedisplay) {
                        case 'noyear':
                            cssText += 'timeyear {display:none !important;}';
                            break;
                        case 'notime':
                            cssText += 'timeclock {display:none !important;}';
                            break;
                        case 'noyearandtime':
                            cssText += 'timeyear, timeclock {display:none !important;}';
                            break;
                    }
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            if (font == 'Source Han Sans CN') {
                loadWebfont(font);
            }
        }

        //加载webfont
        function loadWebfont(font) {
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }

        //获取版本
        var version = app.getVersion();

        //load Animate CSS
        $.fn.extend({
            animateCss: function(animationName, callback) {
                var animationEnd = (function(el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof(el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function() {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });

        //first start
        var uuid = "";
        var firstStart = false;
        //生成一个独立的uuid
        storage.has('uuid', function(error, hasKey) {
            if (error) {
                console.error(error);
                throw (error);
            }
            //err为首次启动
            if (hasKey) {
                storage.get('uuid', function(error, data) {
                    if (error) {
                        console.error(error);
                        throw (error);
                    } else {
                        if (typeof data != 'undefined') {
                            uuid = data.uuid;
                            installstat(uuid);
                            ipcRenderer.send("set-uuid", uuid);
                        }
                    }
                });
            } else {
                uuid = UUID.gen();
                var json = {
                    uuid: uuid
                }
                storage.set('uuid', json);
                firstStart = true;
                installstat(uuid);
                ipcRenderer.send("set-uuid", uuid);
            }
        });

        function installstat(uuid) {
            //异步调用安装量统计
            if (!indebug) {
                var statUrl = 'https://test.backrunner.top/projects/installstat/api/submit.php';
            } else {
                var statUrl = 'http://localhost/projects/installstat/api/submit.php';
            }
            $.ajax({
                url: statUrl,
                type: 'POST',
                data: 'projectid=1&uuid=' + uuid + '&version=' + version,
                dataType: 'JSON',
                success: function(data) {
                    if (data.status == "success") {
                        console.log("InstallStat: Success, " + data.msg);
                    } else {
                        console.warn("InstallStat: Error, " + data.msg);
                    }
                },
                error: function(data) {
                    console.error("InstallStat: Error");
                    console.error(data);
                },
                timeout: 5000
            });
        }
    </script>
</head>

<body class="index-body">
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">Fastnote</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- lockscreen -->
    <div class="container-lockscreen">
        <div class="lockscreen">
            <div class="lockscreen-icon">
                <i class="fa fa-lock" aria-hidden="true"></i>
            </div>
            <div class="lockscreen-form">
                <input type="password" class="brcontrol-input" id="input-lockscreen">
            </div>
        </div>
    </div>
    <script src="static/lockscreen.js"></script>
    </div>
    <!-- notes -->
    <div class="container-main">
        <!-- container-right -->
        <div class="container-right">
            <div class="right-wrapper">
                <!-- multi-selected -->
                <div class="brtoast toast-search">
                    <div class="toast-icon">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </div>
                    <div class="toast-control toast-search-control">
                        <input type="text" class="form-control" id="input-search">
                    </div>
                    <script src="static/search.js"></script>
                    <div class="toast-icon toast-close" id="toast-search-close">
                        <i class="fa fa-times" aria-hidden="true"></i>
                    </div>
                </div>
                <script>
                    $('#toast-search-close').click(function() {
                        closeSearchToast();
                    });
                </script>
                <div class="brtoast toast-multiselected">
                    <p class="toast-normaltext" id="toast-multiselected-text"></p>
                </div>
            </div>
        </div>
        <!-- empty -->
        <div class="note-empty col-lg-12" id="note-empty">
            <div class="note-empty-inner">
                <span data-lang="note_empty">您还没有建立任何的便签<br>在下方你可以快速创建便签</span>
            </div>
        </div>
        <div class="note-empty col-lg-12" id="note-empty-category">
            <div class="note-empty-inner">
                <span data-lang="note_empty_category">当前分类下没有任何便签<br>在下方你可以快速创建该分类的便签</span>
            </div>
        </div>
        <div class="note-empty col-lg-12" id="note-empty-search">
            <div class="note-empty-inner">
                <span>没有找到相关的便签</span>
            </div>
        </div>
        <div class="note-list" id="note-list">
            <div class="note-list-forceTop" id="note-list-forceTop"></div>
            <div class="note-list-normal" id="note-list-normal"></div>
        </div>
        <script>
            //编辑笔记
            ipcRenderer.on('update-edit-note', (event, data) => {
                updateEditNote(data);
            });

            function updateEditNote(res) {
                notesEdit.saveEditNote(res, function(data) {
                    //reset contents in note
                    switch (sort_mode) {
                        //此处接收到的是{note:note, rawtext:text}
                        case 'id':
                            updateEditNoteinArray(data.note); //更新数组内容
                            rerenderEditedNote(data.note, data.rawtext);
                            break;
                        case 'updateDate':
                            updateEditNoteinArray(data.note, true);
                            break;
                    }
                    //show infobar
                    displayInfobar("success", i18n[current_i18n].note_saved);
                });
            }

            //执行notes的替换
            function updateEditNoteinArray(data, refreshList = false) {
                for (var i = 0; i < notes.length; i++) {
                    if (notes[i].id == data.id) {
                        notes[i] = data;
                        if (refreshList) {
                            refreshNoteList();
                        }
                        break;
                    }
                }
            }

            //event restore
            ipcRenderer.on('restore-note', (event, data) => {
                if (notes.length <= 0) {
                    showNoteList();
                }
                addNoteObjToArray(data);
                refreshNoteList(null, function() {
                    bindNoteFoldDBL(data.id);
                });
                //animate
                $('#note_' + data.id).animateCss('fadeInLeft faster');
            });

            //记录是否有置顶便签
            var hasNotesForceTop = false;
            var hasNotesNotForceTop = false;
            //笔记鼠标点击事件绑定
            function bindNoteClickEvent() {
                //滚动条不响应选择事件
                $('.note-content').off('mousedown').on('mousedown', function(e) {
                    if (e.offsetX >= $(this).width()) {
                        e.stopPropagation();
                    }
                });

                $('.note-wrapper').off('mousedown').on('mousedown', function(e) {
                    //提取点击的id
                    noteid_clicked = parseInt($(this).children('.note').attr("data-id"));
                    if (e.which == 1) {
                        if (selectModeEnabled) {
                            //判断是否为置顶
                            if ($(this).children('.note').hasClass('note-forceTop')) {
                                hasNotesForceTop = true;
                            } else {
                                hasNotesNotForceTop = true;
                            }
                            //多选模式下，单击，如果选中则取消，未选中则选中
                            var index = notes_selected.indexOf(noteid_clicked);
                            if (index != -1) {
                                $('#note_' + noteid_clicked).parent().removeClass('note-selected');
                                //非加密便签才进行操作
                                if ($('#note_' + noteid_clicked + ' .note-content .note-text').length > 0) {
                                    notes_selected.removeAt(index);
                                }
                                notes_selected_withencrypted.removeAt(index);
                                //如果没有选中则退出
                                if (notes_selected_withencrypted.length <= 0) {
                                    selectModeEnabled = false;
                                    $('.toast-multiselected').animateCss('fadeOutRight faster', function() {
                                        $('.toast-multiselected').removeClass('toast-active');
                                    });
                                } else {
                                    $('#toast-multiselected-text').html(i18n[current_i18n].selected_left + notes_selected.length + i18n[current_i18n].selected_right);
                                }
                            } else {
                                $('#note_' + noteid_clicked).parent().addClass('note-selected');
                                //判断是否为加密便签，是则不操作
                                if ($('#note_' + noteid_clicked + ' .note-content .note-text').length > 0) {
                                    notes_selected.push(noteid_clicked);
                                }
                                notes_selected_withencrypted.push(noteid_clicked);
                                //set up toast
                                $('#toast-multiselected-text').html(i18n[current_i18n].selected_left + notes_selected.length + i18n[current_i18n].selected_right);
                            }
                        } else {
                            noteLongClickTimeout = setTimeout(function() {
                                //初始化值
                                selectModeEnabled = true;
                                notes_selected = [];
                                notes_selected_withencrypted = [];
                                hasNotesForceTop = false;
                                hasNotesNotForceTop = false;
                                //对当前所选进行对应处理
                                $('#note_' + noteid_clicked).parent().addClass('note-selected');
                                if ($('#note_' + noteid_clicked + ' .note-content .note-text').length > 0) {
                                    notes_selected.push(noteid_clicked);
                                }
                                notes_selected_withencrypted.push(noteid_clicked);
                                //判断是否为置顶
                                if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                    hasNotesForceTop = true;
                                } else {
                                    hasNotesNotForceTop = true;
                                }
                                //set up toast
                                $('#toast-multiselected-text').html(i18n[current_i18n].selected_left + notes_selected.length + i18n[current_i18n].selected_right);
                                $('.toast-multiselected').addClass('toast-active').animateCss('fadeInRight faster');
                                window.getSelection().removeAllRanges();
                            }, 1000);
                        }
                    } else if (e.which == 3) {
                        if (selectModeEnabled) {
                            //如果是选中的，弹出菜单，如果不是选中的，取消
                            if ($('#note_' + noteid_clicked).parent().hasClass('note-selected')) {
                                //弹出多选下的右键菜单
                                popup_menu_note_multiSelected(hasNotesForceTop, hasNotesNotForceTop);
                            } else {
                                selectModeEnabled = false;
                                $('.note-wrapper').removeClass('note-selected');
                                $(this).addClass('note-selected');
                                if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                    //是置顶便签
                                    popup_menu_note(true, $('#note_' + noteid_clicked + ' .note-content .note-password').length > 0 && $('#note_' + noteid_clicked + ' .note-content .note-password').css('display') != 'none');
                                } else {
                                    //不是置顶便签
                                    popup_menu_note(false, $('#note_' + noteid_clicked + ' .note-content .note-password').length > 0 && $('#note_' + noteid_clicked + ' .note-content .note-password').css('display') != 'none');
                                }
                                $('.toast-multiselected').animateCss('fadeOutRight faster', function() {
                                    $('.toast-multiselected').removeClass('toast-active');
                                });
                            }
                        } else {
                            $('.note-wrapper').removeClass('note-selected');
                            $(this).addClass('note-selected');
                            if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                //是置顶便签
                                popup_menu_note(true, $('#note_' + noteid_clicked + ' .note-content .note-password').length > 0 && $('#note_' + noteid_clicked + ' .note-content .note-password').css('display') != 'none');
                            } else {
                                //不是置顶便签
                                popup_menu_note(false, $('#note_' + noteid_clicked + ' .note-content .note-password').length > 0 && $('#note_' + noteid_clicked + ' .note-content .note-password').css('display') != 'none');
                            }
                        }
                    }
                    //阻止事件冒泡到父元素
                    e.stopPropagation();
                });
                //取消长按的计时器
                $('.note-wrapper').off('mouseup').on('mouseup', function(e) {
                    if (e.which == 1) {
                        clearTimeout(noteLongClickTimeout);
                    }
                });
            }

            //如果移动了鼠标则取消长按计时
            $('body').on('mousemove', function(e) {
                clearTimeout(noteLongClickTimeout);
            });

            $(document).ready(function() {
                //绑定note-list的鼠标点击
                $('#note-list').mousedown(function(e) {
                    if (selectModeEnabled) {
                        selectModeEnabled = false;
                        $('.note-wrapper').removeClass('note-selected');
                        $('.toast-multiselected').animateCss('fadeOutRight faster', function() {
                            $('.toast-multiselected').removeClass('toast-active');
                        });
                    }
                    //搜索框内没有输入内容时点击列表自动关闭
                    if (searchOpened) {
                        if ($('#input-search').val().length < 1) {
                            closeSearchToast();
                        }
                    }
                });
            });

            //绑定全选快捷键
            Mousetrap.bind('ctrl+a', function() {
                selectModeEnabled = true;
                notes_selected = [];
                notes_selected_withencrypted = [];
                notes.forEach(note => {
                    if (typeof note.password == "undefined") {
                        notes_selected.push(note.id);
                    }
                    notes_selected_withencrypted.push(note.id);
                });
                $('.note-wrapper').addClass('note-selected');
                if (!$('.toast-multiselected').hasClass('toast-active')) {
                    $('.toast-multiselected').addClass('toast-active').animateCss('fadeInRight faster');
                }
                $('#toast-multiselected-text').html(i18n[current_i18n].selected_left + notes_selected.length + i18n[current_i18n].selected_right);
                return false;
            });

            Mousetrap.bind('ctrl+t', function() {
                ipcRenderer.send('main-window-alwaysontop');
                return false;
            });

            ipcRenderer.on('win-alwaysontop', function(sender, data) {
                if (data) {
                    $('#statusbar-item-alwaysontop').css('display', 'inline-block');
                } else {
                    $('#statusbar-item-alwaysontop').css('display', 'none');
                }
            });
        </script>
    </div>

    <!-- new note -->
    <div class="container-newnote">
        <div class="newnote-info-float">
            <div class="newnote-info-item">
                <div class="br-col-2">
                    <label data-lang="title">标题</label>
                </div>
                <div class="br-col-10">
                    <input type="text" class="form-control" id="input-note-title" maxlength="64" placeholder="(无标题)">
                </div>
            </div>
            <div class="newnote-info-item" id="newnote-info-item-category" style="margin-top: 8px;">
                <div class="br-col-2">
                    <label data-lang="category">分类</label>
                </div>
                <div class="br-col-10">
                    <select class="form-control" id="select-note-category">
                        <option value="notalloc" data-lang="notalloc">未分类</option>
                    </select>
                </div>
            </div>
            <div class="newnote-info-item" id="newnote-info-item-password" style="margin-top: 8px;">
                <div class="br-col-2">
                    <label data-lang="password">密码</label>
                </div>
                <div class="br-col-10">
                    <input type="password" class="form-control" id="input-note-password" maxlength="64" placeholder="(未设置密码)">
                </div>
            </div>
        </div>
        <div class="newnote-main">
            <div class="lbl">
                <label id="lbl-newnote" title="双击打开独立新建便签窗口" data-lang='newnote'>新建便签</label>
                <script>
                    $('#lbl-newnote').dblclick(function() {
                        //双击启动新建便签窗口
                        ipcRenderer.send('openNewnoteWindow', current_category); //启动的时候传递当前分类
                    });
                    //接收回传的保存
                    ipcRenderer.on('newnotewin-save', (sender, data) => {
                        saveNote(data.text, data.title, data.category, data.password, data.markdown);
                    });
                </script>
                <!-- fold -->
                <div class="newnote-fold">
                    <button class="br-btn btn-noback newnote-trigger" id="btn-newnote-fold">
                        <i class="fa fa-chevron-down" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="newnote-info">
                    <button class="br-btn btn-noback newnote-trigger" id="btn-newnote-info">
                        <i class="fa fa-info-circle" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="newnote-markdown">
                    <button class="br-btn btn-noback newnote-trigger" id="btn-newnote-markdown">
                        <svg t="1558625704373" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1534" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200">
                            <path d="M85.333333 682.666667 85.333333 341.333333 170.666667 341.333333 298.666667 469.333333 426.666667 341.333333 512 341.333333 512 682.666667 426.666667 682.666667 426.666667 462.08 298.666667 590.08 170.666667 462.08 170.666667 682.666667 85.333333 682.666667M682.666667 341.333333 810.666667 341.333333 810.666667 512 917.333333 512 746.666667 704 576 512 682.666667 512 682.666667 341.333333Z" p-id="1535" fill="#ffffff"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="control">
                <textarea id="note-text"></textarea>
                <label class="note-text-submittip" data-lang="note_submittip">使用 [Ctrl+回车] 提交</label>
            </div>
        </div>
    </div>
    <script>
        var newnote_info_opened = false;
        //绑定btn-newnote-info
        $('#btn-newnote-info').click(function() {
            if (newnote_info_opened) {
                $('.newnote-info-float').animateCss('fadeOutDown faster', function() {
                    $('.newnote-info-float').css('display', 'none');
                    newnote_info_opened = false;
                });
            } else {
                $('.newnote-info-float').css('display', 'block').animateCss('fadeInUp faster', function() {
                    newnote_info_opened = true;
                });
            }
        });
        $('.container-newnote').click(function() {
            if (newnote_info_opened) {
                $('.newnote-info-float').animateCss('fadeOutDown faster', function() {
                    $('.newnote-info-float').css('display', 'none');
                    newnote_info_opened = false;
                });
            }
        });
        //newnote-info-float 阻止冒泡到上面的事件
        $('.newnote-info-float').click(function(e) {
            e.stopPropagation();
        })

        //markdown
        var markdown_enabled = false;
        $('#btn-newnote-markdown').click(function(e) {
            if (markdown_enabled) {
                markdown_enabled = false;
                $('#btn-newnote-markdown').removeClass('newnote-markdown-checked');
            } else {
                markdown_enabled = true;
                $('#btn-newnote-markdown').addClass('newnote-markdown-checked');
            }
        });
    </script>

    <div class="container-bottombar-float">
        <div class="bottombar-float-wrapper">
            <div class="bottombar-float-update">
                <div id="toast-updateready" class="brtoast toast-autoheight toast-updateready">
                    <div class="toast-normaltext-wrapper">
                        <span class="toast-text" id="toast-updateready-text" data-lang="updateready_text">更新下载完成，应用会在关闭后自动更新。</span>
                    </div>
                    <div class="toast-control toast-control-right">
                        <button class="btn brbtn brbtn-primary" id="updateready-btn-update" data-lang="update_now">立即更新</button>
                        <button class="btn brbtn brbtn-primary" id="updateready-btn-close" data-lang="close">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('#updateready-btn-close').click(() => {
            closeUpdateReadyToast();
        });

        $('#updateready-btn-update').click(()=>{
            ipcRenderer.send('app-quitNow');
        });

        var updateReadyToastOpened = false;

        function popupUpdateReadyToast() {
            updateReadyToastOpened = true;
            $('#toast-updateready').addClass('toast-active');
            $('#toast-updateready').animateCss('fadeInRight faster');
        }

        function closeUpdateReadyToast() {
            if (updateReadyToastOpened) {
                $('#toast-updateready').animateCss('fadeOutRight faster', function() {
                    //focus the input
                    $('#toast-updateready').removeClass('toast-active');
                    updateReadyToastOpened = false;
                });
            }
        }
    </script>

    <div class="container-bottombar">
        <div class="trigger-mainmenu">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-mainmenu-trigger">
                <i class="fa fa-bars" aria-hidden="true"></i>
            </button>
        </div>
        <div class="trigger-category">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-category-trigger">
                <i class="fa fa-book" aria-hidden="true"></i>
                <span class="bottombar-category-name"></span>
            </button>
        </div>
        <div class="trigger-expandnewnote">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-newnote-expand">
                <i class="fa fa-chevron-up" aria-hidden="true"></i>
            </button>
        </div>
        <div class="trigger-cloud">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-cloud-trigger">
                <i class="fa fa-user" aria-hidden="true"></i>
            </button>
        </div>
        <div class="bottom-bar-statusbar" id="statusbar">
            <div class="statusbar-item" id="statusbar-item-alwaysontop"><i class="fa fa-caret-up"></i></div>
        </div>
    </div>

    <script>
        //折叠开关
        var isNoteFolded = false;
        //init
        storage.get('newnoteconfig', function(err, data) {
            if (err || typeof(data) == 'undefined' || data == null || data == "") {
                isNoteFolded = false;
                $('.container-newnote').css('display', 'block');
                $('.trigger-expandnewnote').css('display', 'none');
                setTimeout(function() {
                    $('.note-list').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                    $('.note-empty').css('height', $(window).height() - $('.container-titlebar').height() - 207);
                }, 50);
            } else {
                if (data.isFolded) {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                    $('.trigger-expandnewnote').css('display', 'block');
                    //late execute
                    setTimeout(function() {
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 27);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 27);
                    }, 50);
                } else {
                    isNoteFolded = false;
                    $('.container-newnote').css('display', 'block');
                    $('.trigger-expandnewnote').css('display', 'none');
                    setTimeout(function() {
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 207);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 207);
                    }, 50);
                }
            }
        });
        //绑定折叠事件
        $('#btn-newnote-fold').click(function() {
            if (!isNoteFolded) {
                //set config
                var config = {
                    isFolded: true
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                //animate
                $('.container-newnote').animateCss('fadeOutDown', function() {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                });
                $('.trigger-expandnewnote').css('display', 'block').animateCss('fadeIn');
            }
        });
        $('#btn-newnote-expand').click(function() {
            if (isNoteFolded) {
                //set config
                var config = {
                    isFolded: false
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                //animate
                $('.container-newnote').css('display', 'block').animateCss('fadeInUp');
                $('.trigger-expandnewnote').animateCss('fadeOut', function() {
                    $('.trigger-expandnewnote').css('display', 'none');
                    isNoteFolded = false;
                });
                $('#note-text').focus();
            }
        });
    </script>

    <!-- import clipboard operation-->
    <script src='static/clipboard.copy.js'></script>

    <script>
        var noteid_clicked = -1;

        function getSelectText(id) {
            var t = document.getElementById(id);
            if (window.getSelection) {
                if (t.selectionStart != undefined && t.selectionEnd != undefined) {
                    return t.value.substring(t.selectionStart, t.selectionEnd);
                } else {
                    return "";
                }
            } else {
                return document.selection.createRange().text;
            }
        }

        $(document).ready(function() {
            bindNewnoteRightClickEvent();
        });

        function bindNewnoteRightClickEvent() {
            $('#note-text').mousedown(function(e) {
                if (e.which == 3) {
                    if ($('#note-text').val().trim().length > 0) {
                        if (getSelectText('note-text').length > 0) {
                            popup_menu_textarea_selected();
                        } else {
                            popup_menu_textarea();
                        }
                    } else {
                        popup_menu_textarea_empty();
                    }
                }
            });
        }
    </script>

    <!-- update -->
    <div class="container-updater">
        <div class="update-block">
            <div class="update-title">
                <span id="update-title-span" data-lang="newversion_detected">检测到新版本：</span>
            </div>
            <div class="update-contents">
                <h1 class="update-contents-title" data-lang="update_log">更新日志</h1>
                <div class="update-contents-details">
                </div>
            </div>

            <div class="update-contents update-contents-loading">
                <span id="update-loading-span" data-lang="loading">载入中……</span>
            </div>

            <div class="update-footer">
                <div class="control-group" style="-webkit-user-select: none">
                    <button type="button" class="br-btn btn-noback control-item update-btn" id="btn-update-close" data-lang="close">关闭</button>
                    <button type="button" class="br-btn btn-noback control-item update-btn" id="btn-update-cancel" data-lang="cancel">取消</button>
                    <button type="button" class="br-btn btn-noback control-item update-btn" id="btn-update-confirm" data-lang="download">下载</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ipcRenderer -->
    <script>
        var time = require('../app/tools/time.js');
        var version_new;
        ipcRenderer.on('update-message', (event, {
            message,
            data
        }) => {
            switch (message) {
                case 'checking-for-update':
                    console.log('checking for update...');
                    break;
                case 'update-available':
                    console.log("update-avaliable...");
                    if (typeof settings != 'undefined') {
                        if (!settings.autoUpdateStatus) { //自动更新未启用
                            return;
                        }
                    } else {
                        return; //设置没有载入的情况下不触发更新
                    }
                    $('.container-updater').css('display', 'block').animateCss('fadeIn', function() {
                        var path_verfile = ``;
                        if (typeof settings != 'undefined') {
                            switch (settings.autoUpdateChannel) {
                                case "0":
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                                    break;
                                case "100":
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/pre-release/${process.platform}/ver.json?time=`;
                                    break;
                                default:
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                                    break;
                            }
                        } else {
                            path_verfile =
                                `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                        }
                        $.getJSON(path_verfile + time.getRawCurrentMillTime(), //时间戳避免缓存
                            function(result) {
                                if (result != null && result != "" && typeof(result) != 'undefined') {
                                    //成功获取ver.json
                                    version_new = result.ver;
                                    try {
                                        $('#update-title-span').text(i18n[current_i18n].newversion_detected + result.ver);
                                        document.getElementsByClassName('update-contents-details')[0].innerHTML = insert_spacing(result.text, 0.08);
                                        //选择性显示更新日志，不同版本显示不同内容
                                        var version_number = version.split('.').map(Number); //获取现有的版本号
                                        var update_logs = document.getElementsByClassName('update-contents-details')[0].children; //获取更新日志板块的版本号
                                        //使用try防止ver文件出错导致自动更新不能用
                                        try {
                                            for (var i = 0; i < update_logs.length; i++) {
                                                var log_version = $(update_logs[i]).attr('data-ver').split('.').map(Number);
                                                //判断现有版本是否已经大于更新日志的版本
                                                if (version_number[0] >= log_version[0] && version_number[1] >= log_version[1] && version_number[2] >= log_version[2]) {
                                                    $(update_logs[i]).hide(); //如果有就把这一部分隐藏掉
                                                }
                                            }
                                        } catch (err) {
                                            console.error(err);
                                        }
                                        //check show full
                                        if (result.showfull) {
                                            document.getElementsByClassName('update-contents-details')[0].innerHTML += '<button class="btn btn-primary brbtn-primary update-contents-showfull" onclick="ipcRenderer.send(\'openExternalURL\', \'https://io.backrunner.top/2018/07/08/Fastnote%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97.html\');">' + i18n[current_i18n].detail_updatelog + '</button>'
                                        }
                                        //强制更新
                                        if (typeof result.forceupdate != 'undefined' && result.forceupdate) {
                                            $('#btn-update-confirm').show();
                                        } else {
                                            $('#btn-update-confirm').show();
                                            $('#btn-update-cancel').show();
                                        }
                                        $('.update-contents-loading').css('display', 'none');
                                    } catch (err) {
                                        //获取失败
                                        $('#btn-update-close').show();
                                        console.error(err);
                                        $('#update-loading-span').innerHTML = i18n[current_i18n].loading_updatelog_failed;
                                    }
                                } else {
                                    //获取失败
                                    $('#btn-update-close').show();
                                    $('#update-loading-span').innerHTML = i18n[current_i18n].loading_updatelog_failed;
                                }
                            }
                        );
                    });
                    break;
                case 'downloadProgress':
                    document.getElementById('update-progress').value = data.percent;
                    document.getElementById('infobar-update-text').innerText = i18n[current_i18n].update_downloading + " (" + data.percent.toFixed(
                        1) + " %)......";
                    break;
                case 'update-downloaded':
                    console.log('update-downloaded');
                    //收起上方的通知
                    $('#infobar_update').animateCss('fadeOutUp', function() {
                        $('#infobar_update').remove();
                    });
                    displayInfobar('success', i18n[current_i18n].update_download_success, 5000);
                    //向状态栏添加图标
                    appendUpdateIconToStautsbar();
                case 'error':
                    console.error(data);
                    break;
            }
        });

        function appendUpdateIconToStautsbar() {
            $('#statusbar').append(
                '<div id="statusbar-item-updateready" class="statusbar-item" onclick="popupUpdateReadyToast()";><i class="fa fa-arrow-circle-up"></i></div>'
            );
        }

        //绑定按钮事件
        $('#btn-update-cancel').on('click', function() {
            $('.container-updater').animateCss('fadeOut', function() {
                $('.container-updater').removeAttr('style');
            });
            ipcRenderer.send('updateCancelled');
        });
        $('#btn-update-close').on('click', function() {
            $('.container-updater').animateCss('fadeOut', function() {
                $('.container-updater').removeAttr('style');
            });
            ipcRenderer.send('updateCancelled');
        });
        $('#btn-update-confirm').on('click', function() {
            ipcRenderer.send('downloadNow');
            displayInfobar('update', i18n[current_i18n].update_downloading + '......');
            $('.container-updater').animateCss('fadeOut', function() {
                $('.container-updater').removeAttr('style');
            });
        })
    </script>

    <!-- main menu -->
    <div class="mainmenu-background"></div>
    <div class="container-mainmenu">
        <div class="mainmenu-panel">
            <div class="mainmenu-logo">
                <img src="static/images/logo.png" class="mainmenu-logo-default" />
                <img src="static/images/logo.blackwhite.png" class="mainmenu-logo-blackwhite" />
                <h1>Fastnote</h1>
                <span id="mainmenu-version"></span>
                <script>
                    $(document).ready(function() {
                        $('#mainmenu-version').text(version);
                    });
                </script>
            </div>
            <div class="mainmenu-split"></div>
            <div class="mainmenu-menu">
                <ul>
                    <li id="mainmenu-btn-recycle">
                        <span data-lang="recyclebin">回收站</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-settings">
                        <span data-lang="settings">设置</span>
                    </li>
                    <li id="mainmenu-btn-about">
                        <span data-lang="about">关于</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-reload">
                        <span data-lang="reload">重新载入</span>
                    </li>
                    <li id="mainmenu-btn-exit">
                        <span data-lang="exit">退出</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        //绑定主菜单的动画事件
        let isMainMenuOpen = false;
        $('.mainmenu-background').on('mousedown', function() {
            closeMainMenu();
        });
        //打开主菜单
        $('#btn-mainmenu-trigger').on('click', function() {
            if (!isMainMenuOpen && !isCategoryOpen && !isCloudOpen) {
                openMainMenu();
            }
        });
        //绑定主菜单快捷键
        Mousetrap.bind('esc', function() {
            if (isCategoryOpen) {
                closeCategory();
                $('#note-text').focus();
                return;
            }
            if (isCloudOpen) {
                closeCloudPanel();
                $('#note-text').focus();
                return;
            }
            if (isMainMenuOpen) {
                closeMainMenu();
                $('#note-text').focus();
            } else {
                openMainMenu();
            }
        });

        function openMainMenu() {
            $('.mainmenu-background').css('display', 'block').animateCss('fadeIn');
            $('.container-mainmenu').css('display', 'block').animateCss('fadeInLeft');
            isMainMenuOpen = true;
        }
        //绑定菜单项
        $('#mainmenu-btn-recycle').click(function() {
            ipcRenderer.send("openRecycleWindow");
            closeMainMenu();
        });
        //打开回收站的全局快捷键
        Mousetrap.bind('shift+r', function() {
            ipcRenderer.send("openRecycleWindow");
        });
        $('#mainmenu-btn-settings').click(function() {
            ipcRenderer.send("openSettingsWindow"); //打开关于窗口
            closeMainMenu();
        });
        //打开的设置全局快捷键
        Mousetrap.bind('shift+s', function() {
            ipcRenderer.send("openSettingsWindow");
        });
        //锁屏全局快捷键
        Mousetrap.bind('ctrl+l', function() {
            enableLockScreen();
        });
        $('#mainmenu-btn-about').click(function() {
            ipcRenderer.send("openAboutWindow"); //打开关于窗口
            closeMainMenu();
        });
        $('#mainmenu-btn-reload').click(function() {
            ipcRenderer.send("reloadMainWindow"); //重载
            ipcRenderer.send('reloadRecycleWindow');
            ipcRenderer.send('reloadAllEditWindow');
            ipcRenderer.send('reloadAboutWindow');
            ipcRenderer.send('reloadAllWidgets');
            ipcRenderer.send('reloadLoginWindow');
            closeMainMenu();
        });
        $('#mainmenu-btn-exit').click(function() {
            ipcRenderer.send("app-quitNow"); //退出程序
            closeMainMenu();
        });

        function closeMainMenu() {
            if (isMainMenuOpen) {
                $('.mainmenu-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.mainmenu-background').animateCss('fadeOut', function() {
                    $('.mainmenu-background').css('display', 'none');
                })
                $('.container-mainmenu').animateCss('fadeOutLeft', function() {
                    $('.container-mainmenu').css('display', 'none');
                    isMainMenuOpen = false;
                })
            }
        }

        //bind resize
        $(window).resize(function() { //当浏览器大小变化时
            var windowHeight = $(window).height();
            //调整list的高度
            var listHeight = 0;
            if ($('.container-newnote').css('display') == 'none') {
                listHeight = $(window).height() - $('.container-titlebar').height() - 27;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            } else {
                listHeight = $(window).height() - $('.container-titlebar').height() - 207;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            }
            //调整note的高度
            $('.note-content').each(function() {
                if ($(this).attr('class').indexOf('note-overheight') == -1) {
                    $(this).css('height', 'auto');
                }
            });
        });
    </script>

    <div class="category-background"></div>
    <div class="container-category">
        <div class="category-panel">
            <div class="category-header">
                <div class="category-header-title">
                    <p data-lang="note_category">便签分类</p>
                </div>
                <div class="category-header-button">
                    <i class="fa fa-edit" id="category-header-editbtn" aria-hidden="true"></i>
                    <i class="fa fa-check" id="category-header-confirmbtn" aria-hidden="true"></i>
                </div>
            </div>
            <div class="category-split"></div>
            <div class="category-body">
                <ul id="category-menu">
                    <div class="category-menu-fixed">
                        <li data-name="all">
                            <div id="category-system-all">
                                <div class="category-item-name">
                                    <span data-lang="all_notes">所有便签</span>
                                </div>
                                <div class="category-item-count">
                                    <span id="category-count-all"></span>
                                </div>
                            </div>
                        </li>
                        <li data-name="notalloc">
                            <div id="category-system-notalloc">
                                <div class="category-item-name">
                                    <span data-lang="notalloc">未分类</span>
                                </div>
                                <div class="category-item-count">
                                    <span id="category-count-notalloc"></span>
                                </div>
                            </div>
                        </li>
                    </div>
                    <div class="category-split"></div>
                    <div class="category-menu-custom"></div>
                    <div class="category-menu-system">
                        <li id="category-add">
                            <div class="category-icon-add"><i class="fa fa-plus" aria-hidden="true"></i></div>
                        </li>
                        <li id="category-add-inside">
                            <div class="category-ctrl-add">
                                <div class="category-add-input">
                                    <input id="input-category-add" type="text">
                                </div>
                                <div class="category-add-btn">
                                    <i class="fa fa-times" aria-hidden="true"></i>
                                </div>
                            </div>
                        </li>
                    </div>
                </ul>
            </div>
        </div>
    </div>

    <script>
        var isCategoryOpen = false;

        function openCategory() {
            $('.category-background').css('display', 'block');
            $('.category-background').animateCss('fadeIn');
            $('.container-category').css('display', 'block');
            $('.container-category').animateCss('fadeInLeft');
            isCategoryOpen = true;
        }

        function closeCategory() {
            if (isCategoryOpen) {
                disableCategoryEditMode(); //关闭时禁用编辑模式
                $('.category-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.category-background').animateCss('fadeOut', function() {
                    $('.category-background').css('display', 'none');
                });
                $('.container-category').animateCss('fadeOutLeft', function() {
                    $('.container-category').css('display', 'none');
                    isCategoryOpen = false;
                });
            }
        }

        $('#category-add-inside').mouseenter(function() {
            $('.category-add-input input').addClass('category-focused');
        });
        $('#category-add-inside').mouseleave(function() {
            $('.category-add-input input').removeClass('category-focused');
        })
        $('#category-add').click(function() {
            $('#category-add').animateCss('fadeOut morefaster', function() {
                $('#category-add').hide();
                $('#category-add-inside').show();
                $('#input-category-add').focus().val("");
                $('#category-add-inside').animateCss('fadeIn morefaster');
            });
        });
        $('.category-add-btn').click(function() {
            $('#category-add-inside').animateCss('fadeOut morefaster', function() {
                $('#input-category-add').removeClass('br-invalid-underline');
                $('#category-add-inside').hide();
                $('#category-add').show();
                $('#category-add').animateCss('fadeIn morefaster');
            });
        });

        $('#input-category-add').keypress(function(e) {
            if (e.which == 13) {
                var category_name = $('#input-category-add').val().trim();
                $('#input-category-add').val('');
                if (category_name < 1) {
                    return;
                }
                if (existCategory(category_name) || category_name in new Array("all", "notalloc")) {
                    //仓库已存在或属于保留字
                    $('#input-category-add').addClass('br-invalid-underline');
                } else {
                    //仓库不存在
                    $('#category-add-inside').animateCss('fadeOut morefaster', function() {
                        $('#input-category-add').removeClass('br-invalid-underline');
                        $('#category-add-inside').hide();
                        putCategoryToArr(category_name); //添加到数组
                        //通知主进程分类有更改
                        ipcRenderer.send('category_added', category_name);
                        renderCategoryToList(categories.length - 1, category_name, 0, true); //渲染到页面
                        renderCategoryToSelect(category_name); //渲染到select
                        saveCategories(); //保存便签分类
                        $('#category-add').show();
                        $('#category-add').animateCss('fadeIn morefaster');
                    });
                }
            }
        });

        $('#btn-category-trigger').on('click', function() {
            if (!isMainMenuOpen && !isCategoryOpen && !isCloudOpen) {
                openCategory();
            }
        });
        $('.category-background').on('mousedown', function() {
            closeCategory();
        });

        //绑定除了add的每个li的点击
        $(document).on('click', '#category-menu li:not(#category-add):not(#category-add-inside)', function() {
            let category_clicked = $(this).attr('data-name');
            if (category_clicked != current_category && !categoryEditMode) {
                //移除选中
                switch (current_category) {
                    default:
                        $('#category-custom-' + current_category).removeClass('category-selected');
                        break;
                    case 'all':
                    case 'notalloc':
                        $('#category-system-' + current_category).removeClass('category-selected');
                        break;
                }
                current_category = category_clicked;
                //渲染选择
                renderCurrentCategory();
                //隐藏不属于当前类别的
                renderNotesOfCategory(current_category);
                //调整select
                if (current_category != 'all') {
                    $('#select-note-category').val(current_category);
                } else {
                    //为all则设置为未分类
                    $('#select-note-category').val('notalloc');
                }
                //写入current_category
                saveCurrentCategory();
            }
        });
        $(document).on('dblclick', '#category-menu li:not(#category-add):not(#category-add-inside)', function() {
            let category_clicked = $(this).attr('data-name');
            if (!categoryEditMode || category_clicked == 'all' || category_clicked == 'notalloc') {
                return;
            }
            $('#category-custom-' + category_clicked).children('.category-item-name').children('span').hide();
            $('#category-custom-' + category_clicked).children('.category-item-name').children('input').show();
            //解决光标在input最前面的问题
            let t = $('#category-custom-' + category_clicked).children('.category-item-name').children('input').val();
            $('#category-custom-' + category_clicked).children('.category-item-name').children('input').val("").focus().val(t);
        });

        //绑定每个自定义分类中的删除按钮
        $(document).on('click', '.category-item-delbtn', function() {
            //获取分类名称
            var name = $(this).parent().parent().attr('data-name');
            dialog.showMessageBox({
                type: "warning",
                buttons: [i18n[current_i18n].button_cancel, i18n[current_i18n].button_delete, i18n[current_i18n].delete_category_and_note],
                defaultId: 0,
                title: i18n[current_i18n].confirm_operation,
                message: i18n[current_i18n].confirm_delete_category_left + name + i18n[current_i18n].confirm_delete_category_right,
                detail: i18n[current_i18n].delete_category_and_note_detail
            }, function(res) {
                if (res != 0) {
                    //确定删除
                    if (res == 1) {
                        removeCategory(name);
                        //该分类下的便签分类全部修改为未分类
                        setNotesCategory(name, undefined);
                    } else if (res == 2) {
                        removeNotesOfCategory(name);
                        removeCategory(name, false);
                    }
                }
            });
        });

        function removeCategory(name, renderCount = true) {
            //删除分类
            removeCategoryFromArr(name);
            ipcRenderer.send('category_removed', name);
            saveCategories();
            $('#category-custom-' + name).parent().animateCss("fadeOutLeft faster", function() {
                $('#category-custom-' + name).parent().remove();
            });
            //删除select中的项
            $('#select-note-category option[value="' + name + '"]').remove();
            //如果当前分类为被删除的分类，则切换到所有便签
            if (current_category == name) {
                current_category = 'all';
                if (renderCount) {
                    renderCurrentCategory();
                    renderNotesOfCategory(current_category);
                }
                $('#select-note-category').val('notalloc');
            }
        }

        function removeNotesOfCategory(name) {
            var notes_tobeDeleted = [];
            for (var i = 0; i < notes.length; i++) {
                if (notes[i].category == name) {
                    notes_tobeDeleted.push(i);
                }
            }
            //删除便签
            for (var i = 0; i < notes_tobeDeleted.length; i++) {
                //检查offset
                var path;
                if (notes[notes_tobeDeleted[i]].offset > 0) {
                    path = storagePath + (global.indebug ? '/devTemp' : '') + '/notes/' + notes[notes_tobeDeleted[i]].rawtime + '.' + notes[tobeDeleted[i]].offset + '.json';
                } else {
                    path = storagePath + (global.indebug ? '/devTemp' : '') + '/notes/' + notes[notes_tobeDeleted[i]].rawtime + '.json';
                }
                if (fs.existsSync(path)) {
                    //删除文件
                    fs.unlinkSync(path);
                    //render
                    if (current_category == 'all') {
                        var noteid = notes[notes_tobeDeleted[i]].id;
                        $('#note_' + noteid).parent().animateCss('fadeOutLeft faster', function() {
                            $('#note_' + noteid).parent().remove();
                        });
                    }
                    notes.splice(notes_tobeDeleted[i], 1);
                }
            }
            renderCurrentCategory();
            renderNotesOfCategory(current_category);
        }

        var categoryEditMode = false;

        //绑定编辑按钮
        $('.category-header-button').click(function() {
            if (categoryEditMode) {
                disableCategoryEditMode();
                saveCategoriesName();
            } else {
                enableCategoryEditMode();
            }
        });

        //sortable
        sortable('.category-menu-custom', {
            items: 'li',
            forcePlaceholderSize: true
        })[0].addEventListener('sortupdate', function(e) {
            var name = $(e.detail.item).attr('data-name'); //获取拖动的名称
            //列表的index和categories的index对应，交换
            var t = categories[e.detail.origin.index];
            categories[e.detail.origin.index] = categories[e.detail.destination.index];
            categories[e.detail.destination.index] = t;
            saveCategories();
        });

        function enableCategoryEditMode() {
            // == 分类编辑模式启用 ==
            categoryEditMode = true;
            //顶部按钮改变
            $('#category-header-confirmbtn').show();
            $('#category-header-editbtn').hide();
            //更改底部便签的显示
            $('.category-item-delbtn').show();
            $('.category-menu-custom .category-item-count').hide();
            //sortable
            $('.category-menu-custom li').css('-webkit-user-drag', 'auto');
            $('.category-menu-custom li').css('-webkit-user-select', 'auto');
        }

        function disableCategoryEditMode() {
            // == 分类编辑模式禁用 ==
            categoryEditMode = false;
            //顶部按钮改变
            $('#category-header-editbtn').show();
            $('#category-header-confirmbtn').hide();
            //更改底部便签的显示
            $('.category-menu-custom .category-item-count').show();
            $('.category-item-delbtn').hide();
            //sortable
            $('.category-menu-custom li').css('-webkit-user-drag', 'none');
            $('.category-menu-custom li').css('-webkit-user-select', 'none');
        }

        function saveCategoriesName() {
            $('.category-edit-input').each((i, e) => {
                let index = parseInt($(e).attr('data-index'));
                let newname = $(e).val().trim();
                //判断名称是否发生了改变
                if (categories[index].name != newname) {
                    //当前分类的名称发生了修改
                    if (categories[index].name == current_category) {
                        //更新当前分类相关的内容
                        current_category = newname;
                        saveCurrentCategory();
                        renderCurrentCategory();
                    }
                    //修改当前的data-name
                    $('#category-custom-' + categories[index].name).parent().attr('data-name', newname);
                    //修改id
                    $('#category-custom-' + categories[index].name).attr('id', 'category-custom-' + newname);
                    //向其他窗口发送rename通知
                    ipcRenderer.send('category_rename', {
                        index: index,
                        newname: newname
                    });
                    //改写便签的分类名称
                    renameCategoryOfNote(categories[index].name, newname);
                }
                categories[index].name = newname;
            });
            saveCategories();
            //重新渲染分类相关的内容
            renderCategorySelect();
        }

        function renameCategoryOfNote(oldname, newname) {
            notes.forEach(note => {
                if (note.category == oldname) {
                    note.category = newname;
                    saveNoteByObj(note);
                }
            });
        }
    </script>

    <div class="cloud-background"></div>
    <div class="container-cloud">
        <div class="cloud-panel">
            <div class="cloud-header">
                <div class="cloud-header-title">
                    <p>Fastnote Cloud</p>
                </div>
            </div>
            <div class="category-split"></div>
            <div class="cloud-body cloud-body-notlogin">
                <ul class="cloud-menu">
                    <li id="cloud-menuitem-login">
                        <div class="cloud-menuitem-label">
                            <span data-lang="login">登录</span>
                        </div>
                    </li>
                    <li id="cloud-menuitem-register">
                        <div class="cloud-menuitem-label">
                            <span data-lang="register">注册</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        var isCloudOpen = false;

        function openCloudPanel() {
            $('.cloud-background').css('display', 'block');
            $('.cloud-background').animateCss('fadeIn');
            $('.container-cloud').css('display', 'block');
            $('.container-cloud').animateCss('fadeInLeft');
            //根据登录状态决定启用

            isCloudOpen = true;
        }

        function closeCloudPanel() {
            if (isCloudOpen) {
                $('.cloud-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.cloud-background').animateCss('fadeOut', function() {
                    $('.cloud-background').css('display', 'none');
                });
                $('.container-cloud').animateCss('fadeOutLeft', function() {
                    $('.container-cloud').css('display', 'none');
                    isCloudOpen = false;
                });
            }
        }

        $('#btn-cloud-trigger').on('click', () => {
            if (!isMainMenuOpen && !isCategoryOpen && !isCloudOpen) {
                openCloudPanel();
            }
        });

        $('.cloud-background').on('mousedown', () => {
            closeCloudPanel();
        });

        //menu item events
        $('#cloud-menuitem-login').on('click', () => {
            ipcRenderer.send('openLoginWindow');
            closeCloudPanel();
        });
        $('#cloud-menuitem-register').on('click', () => {
            ipcRenderer.send('openRegisterWindow');
            closeCloudPanel();
        });
    </script>

    <script>
        //backup recovered
        ipcRenderer.on('backup-recover-completed', function() {
            console.log('backup recovered');
            //刷新便签列表
            readNoteFiles();
            //获取最大的便签id，刷新为新的便签id
            var maxNoteId = 0;
            //检测NoteID冲突
            var existedNoteId = [];
            var conflictNotes = [];
            //遍历现有的便签
            notes.forEach(note => {
                if (note.id > maxNoteId) {
                    maxNoteId = note.id;
                }
                //检测noteid是否有冲突，用户在本地的noteid应尽可能保持唯一。
                if (existedNoteId.indexOf(note.id) != -1) {
                    existedNoteId.push(note.id);
                } else {
                    //存在冲突
                    conflictNotes.push(note);
                }
            });
            //重新设置noteid
            notesid = maxNoteId + 1;
            //检测是否存在冲突的便签
            if (conflictNotes.length > 0) {
                //构造细节
                var detail = i18n[current_i18n].note_conflict_detail;
                conflictNotes.forEach(note => {
                    detail += "ID: " + note.id + i18n[current_i18n].note_conflict_detail_content + (note.text.length > 20 ? note.text.substring(
                        0, 20) + "..." : note.text) + "\n";
                });
                dialog.showMessageBox({
                    title: i18n[current_i18n].notes_conflict,
                    message: i18n[current_i18n].notes_conflict_message,
                    detail: detail,
                    buttons: [i18n[current_i18n].button_dealwithconflict, i18n[current_i18n].button_delete]
                }, function(res) {
                    if (res == 0) {
                        //处理冲突
                        conflictNotes.forEach(note => {
                            note.id = notesid;
                            saveNoteByObj(note);
                            notesid++;
                        });
                        //冲突处理完毕
                        readNoteFiles();
                        saveNotesId();
                    } else if (res == 1) {
                        dialog.showMessageBox({
                            type: 'warning',
                            message: i18n[current_i18n].delete_conflict_notes,
                            detail: detail,
                            buttons: [i18n[current_i18n].button_yes, i18n[current_i18n].button_no]
                        }, function(res) {
                            if (res == 0) {
                                conflictNotes.forEach(note => {
                                    deleteNoteByObj(note);
                                });
                                //删除完毕
                                readNoteFiles();
                                saveNotesId();
                            }
                        });
                    }
                });
            }
            saveNotesId();
        });
    </script>

    <script>
        //取消加密
        ipcRenderer.on('cancel-encryption', function(sender, data) {
            removePassword(data.id, data.rawpassword);
            $('#note_' + data.id + ' .note-header .note-password-relock').remove();
            $('#note_' + data.id + ' .note-content .note-password').animateCss('fadeOut morefaster', function() {
                $('#note_' + data.id + ' .note-content .note-password').remove();
            });
        });

        function removePassword(noteid, rawpassword) {
            for (var i = 0; i < notes.length; i++) {
                if (notes[i].id == noteid) {
                    notes[i].password = undefined; //取消密码
                    notes[i].text = aes_decrypt(notes[i].text, rawpassword);
                    saveNoteByObj(notes[i]); //保存
                    displayInfobar('success', i18n[current_i18n].note_unencrypted_sharp + noteid + i18n[current_i18n].note_unencrypted_right);
                    rerenderTextOfNote(noteid, notes[i].text, true);
                    break;
                }
            }
        }
    </script>

    <script>
        //聚焦到输入文本框
        $(document).ready(function() {
            $('#note-text').focus();
        });

        //关闭选项的flag
        var reloadWindow = false;
        var closeOptionDialogShow = false;

        ipcRenderer.on('before-reload', () => {
            reloadWindow = true;
        });

        //复写关闭窗口事件
        window.onbeforeunload = (e) => {
            if (reloadWindow) {
                return;
            }
            if (!settings.closeOption) {
                if (!closeOptionDialogShow) {
                    closeOptionDialogShow = true;
                    dialog.showMessageBox({
                        type: 'info',
                        title: i18n[current_i18n].close_mainwindow_title,
                        buttons: [i18n[current_i18n].close_minimize_to_tray, i18n[current_i18n].close_just_close],
                        message: i18n[current_i18n].close_mainwindow_msg,
                        defaultId: 0
                    }, (id) => {
                        switch (id) {
                            case 0:
                                //复写设置
                                settings.closeOption = 'tray';
                                storage.set('settings', settings, (err) => {
                                    if (err) {
                                        console.error(err)
                                    }
                                });
                                window.close();
                                break;
                            case 1:
                                //复写设置
                                settings.closeOption = 'close';
                                //保存设置
                                storage.set('settings', settings, (err) => {
                                    if (err) {
                                        console.error(err)
                                    }
                                });
                                ipcRenderer.send('app-quitNow');
                                break;
                            default:
                                window.close();
                                break;
                        }
                        reloadWindow = false;
                        closeOptionDialogShow = false;
                    });
                    e.returnValue = false;
                }
            } else {
                switch (settings.closeOption) {
                    case 'close':
                        ipcRenderer.send('app-quitNow');
                        break;
                    case 'tray':
                        window.close();
                        break;
                }
            }
        }

        ipcRenderer.on('tray-reload', () => {
            ipcRenderer.send("reloadMainWindow"); //重载
            ipcRenderer.send('reloadRecycleWindow');
            ipcRenderer.send('reloadAllEditWindow');
            ipcRenderer.send('reloadAboutWindow');
            ipcRenderer.send('reloadAllWidgets');
            ipcRenderer.send('reloadLoginWindow');
            closeMainMenu();
        });
    </script>

    <script>
        var cloud_serveronline = true;
        //检测服务器状态
        function checkServerStatus(onlineCallback) {
            $.ajax({
                url: cloud_apibase + '/common/ping',
                type: 'GET',
                dataType: 'json',
                timeout: 1000,
                success: () => {
                    if (!cloud_serveronline) {
                        console.log('Fastnote Cloud server is online now, user module enabled.');
                    }
                    cloud_serveronline = true;
                    $('.trigger-cloud').css('display', 'inline-block');
                    if (typeof onlineCallback == "function") {
                        onlineCallback();
                    }
                },
                error: () => {
                    if (cloud_serveronline) {
                        console.error('Fastnote Cloud server is not online, user module disabled.');
                    }
                    cloud_serveronline = false;
                    //每5分钟检查一次服务器是否在线
                    setTimeout(() => {
                        checkServerStatus();
                    }, 300000);
                }
            })
        }

        //检查登录状态
        function checkLogin() {
            storage.get('cloud_usertoken', (err, data) => {
                if (err) {
                    //cloud_usertoken不存在则获取token
                    fetchUserToken();
                } else {
                    console.log(data);
                }
            });
        }

        //获取授权token
        function fetchUserToken() {
            storage.get('cloud_userconfig', (err, data) => {
                if (err) {
                    //不存在userconfig
                    console.error('Local cloud user config not found. Can\'t login to the server automatically.');
                }
            });
        }

        //执行服务器状态检查，如果服务器在线则检查登录状态
        checkServerStatus();

        //注册成功事件
        ipcRenderer.on('cloud-register-success', (sender, data) => {
            //拉取用户信息
            displayInfobar('success', i18n[current_i18n].register_success);
            fetchUserInfo(data);
        });
        //登录成功事件
        ipcRenderer.on('cloud-login-success', (sender, data) => {
            //拉取用户信息
            displayInfobar('success', i18n[current_i18n].login_success);
            fetchUserInfo(data);
        });

        function fetchUserInfo(data) {
            $.ajax({
                url: cloud_apibase + '/user/getInfo',
                type: 'GET',
                dataType: 'json',
                headers: {
                    Authorization: "Bearer " + data.token.token
                },
                success: (res) => {
                    if (res.code == 200) {
                        console.log(res);
                    } else {
                        console.error('error', '获取用户信息失败，请尝试手动登录');
                    }
                },
                error: (res) => {
                    console.error('error', '获取用户信息失败，请尝试手动登录');
                }
            });
        }
    </script>

    <script>
        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
        $.getScript('../app/notes.js');
    </script>

    <script>
        //屏蔽开发工具
        if (!indebug) {
            Mousetrap.bind('ctrl+shift+i', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('textarea').on('keydown', (e) => {
                var ctrlKey = e.ctrlKey || e.metaKey;
                if (ctrlKey && e.shiftKey && e.keyCode == 73) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            $(document).on('keydown', 'input[type="password"]', (e) => {
                var ctrlKey = e.ctrlKey || e.metaKey;
                if (ctrlKey && e.shiftKey && e.keyCode == 73) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            $(document).on('keydown', 'input[type="text"]', (e) => {
                var ctrlKey = e.ctrlKey || e.metaKey;
                if (ctrlKey && e.shiftKey && e.keyCode == 73) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }
    </script>

    <span id="filter-x" style="display:none"></span>

</body>

</html>