<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fastnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--import requirements-->
    <script>
        window.$ = window.jQuery = require('./static/jquery.min.js');
        require('./static/bootstrap.min.js');
    </script>

    <link rel="stylesheet" id="main-style" type="text/css" media="screen" href="static/main.white.css">
    <link rel="stylesheet" href="static/font-awesome.min.css">
    <link rel="stylesheet" href="static/bootstrap.min.css">
    <link rel="stylesheet" href="static/animate.min.css">
    <script src="static/array.js"></script>
    <script src="static/han.simple.js"></script>
    <script src="static/notes.render.js"></script>
    <script src="static/mousetrap.min.js"></script>
    <script>
        //define const
        const remote = require('electron').remote;
        const app = remote.app;
        //import json storage
        if (typeof storage != 'undefined') {
            var storage = require('electron-json-storage');
        }

        //dialog
        const {
            dialog
        } = require('electron').remote;

        const Menu = remote.Menu;
        const MenuItem = remote.MenuItem;

        const {
            ipcRenderer
        } = require('electron');

        const notesEdit = require("../app/notes_edit.js");

        //tools
        const UUID = require('../app/tools/uuid.js');
        const indebug = remote.getGlobal('indebug');

        const WebFont = require('webfontloader');

        //import menu
        $.getScript('static/menu.note.js');
        $.getScript('static/menu.textarea.js');

        //设置项
        var settings;
        storage.get('settings', function (error, data) {
            if (error) {
                console.error(error);
                settingsInit(null);
                return;
            } else {
                //获取callback回传的json
                settings = data;
                settingsInit(settings);
            }
            //设置加载完成，显示窗体
            $(document).ready(function () {
                ipcRenderer.send("main-window-ready");
            });
        });

        function settingsInit(settings) {
            var cssText = "";
            var font = "";
            //build css
            if (settings == null) {
                //read error
                $('#main-style').attr('href', 'static/main.blackwhite.css');

                cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;}'; //font
                font = 'Source Han Sans CN';

                console.error('A error occured when reading settings.');
            } else {
                //read success
                if (typeof settings.theme != 'undefined') {
                    $('#main-style').attr('href', 'static/main.' + settings.theme + '.css');
                } else {
                    $('#main-style').attr('href', 'static/main.blackwhite.css');
                }

                if (typeof settings.fontfamily != 'undefined') {
                    cssText += 'body {font-family:' + settings.fontfamily + ', Arial !important;}'; //font
                    font = settings.fontfamily;
                } else {
                    cssText += 'body {font-family:Source Han Sans CN, MicroSoft Yahei, Arial !important;';
                    font = 'Source Han Sans CN';
                }

                //笔记显示设置初始化
                cssText += '.note-content p{';
                if (typeof settings.fontsize != 'undefined') {
                    cssText += 'font-size:' + settings.fontsize + 'px !important;';
                }
                if (typeof settings.lineheight != 'undefined') {
                    cssText += 'line-height:' + settings.lineheight + 'px !important;';
                }
                if (typeof settings.textalign != 'undefined') {
                    cssText += 'text-align:' + settings.textalign + ' !important;'; //note text align
                }
                if (typeof settings.letterspacing != 'undefined') {
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'

                cssText += '.note-content a{';
                if (typeof settings.fontsize != 'undefined') {
                    cssText += 'font-size:' + settings.fontsize + 'px !important;';
                }
                if (typeof settings.letterspacing != 'undefined') {
                    cssText += 'letter-spacing:' + settings.letterspacing + 'em !important;';
                }
                cssText += '}'

                //日期显示初始化
                if (typeof settings.datedisplay != 'undefined') {
                    switch (settings.datedisplay) {
                        case 'createonly':
                            cssText += '.note-updatetime {display:none !important;}';
                            cssText += '.note-createtime-label {display:none !important;}';
                            break;
                        case 'updateonly':
                            cssText += '.note-createtime {display:none !important;}';
                            cssText += '.note-updatetime-label {display:none !important;}';
                            break;
                    }
                }
            }
            var modStyle = document.querySelector('#modCSS');
            if (modStyle === null) {
                modStyle = document.createElement('style');
                modStyle.id = 'modCSS';
                document.body.appendChild(modStyle);
            }
            modStyle.innerHTML = cssText;

            if (font == 'Source Han Sans CN') {
                loadWebfont(font);
            }
        }

        //加载webfont
        function loadWebfont(font) {
            WebFont.load({
                custom: {
                    families: [font]
                }
            });
        }

        //获取版本
        var version = app.getVersion();

        //load Animate CSS
        $.fn.extend({
            animateCss: function (animationName, callback) {
                var animationEnd = (function (el) {
                    var animations = {
                        animation: 'animationend',
                        OAnimation: 'oAnimationEnd',
                        MozAnimation: 'mozAnimationEnd',
                        WebkitAnimation: 'webkitAnimationEnd',
                    };

                    for (var t in animations) {
                        if (typeof (el.style[t]) !== 'undefined') {
                            return animations[t];
                        }
                    }
                })(document.createElement('div'));

                this.addClass('animated ' + animationName).one(animationEnd, function () {
                    $(this).removeClass('animated ' + animationName);
                    if (typeof callback === 'function') callback();
                });

                return this;
            },
        });

        //first start
        var uuid = "";
        var firstStart = false;
        //生成一个独立的uuid
        storage.has('uuid', function (error, hasKey) {
            if (error) {
                console.error(error);
                throw (error);
            }
            //err为首次启动
            if (hasKey) {
                storage.get('uuid', function (error, data) {
                    if (error) {
                        console.error(error);
                        throw (error);
                    } else {
                        if (typeof data != 'undefined') {
                            uuid = data.uuid;
                            installstat(uuid);
                            ipcRenderer.send("set-uuid", uuid);
                        }
                    }
                });
            } else {
                uuid = UUID.gen();
                var json = {
                    uuid: uuid
                }
                storage.set('uuid', json);
                firstStart = true;
                installstat(uuid);
                ipcRenderer.send("set-uuid", uuid);
                addTiptoEmptyInfo();
            }
        });

        function installstat(uuid) {
            //异步调用安装量统计
            if (!indebug) {
                var statUrl = 'https://test.backrunner.top/projects/installstat/api/submit.php';
            } else {
                var statUrl = 'http://localhost/projects/installstat/api/submit.php';
            }
            $.ajax({
                url: statUrl,
                type: 'POST',
                data: 'projectid=1&uuid=' + uuid + '&version=' + version,
                dataType: 'JSON',
                success: function (data) {
                    if (data.status == "success") {
                        console.log("InstallStat: Success, " + data.msg);
                    } else {
                        console.warn("InstallStat: Error, " + data.msg);
                    }
                },
                error: function (data) {
                    console.error("InstallStat: Error");
                    console.error(data);
                },
                timeout: 5000
            });
        }
    </script>
</head>

<body class="index-body">
    <!-- titlebar -->
    <div class="container-titlebar col-lg-12 drag">
        <div class="title" id="app-title">Fastnote</div>
        <div id="electron-titlebar" class="titlebar" style="position: fixed !important;z-index: 10;"></div>
    </div>
    <script>
        require('electron-titlebar');
    </script>
    <!-- infobar -->
    <div class="container-infobar">
    </div>
    <!-- notes -->
    <div class="container-main">
        <!-- container-right -->
        <div class="container-right">
            <div class="right-wrapper">
                <!-- multi-selected -->
                <div class="brtoast toast-multiselected">
                    <p class="brtoast-normaltext" id="toast-multiselected-text"></p>
                </div>
            </div>
        </div>
        <!-- empty -->
        <div class="note-empty col-lg-12" id="note-empty">
            <span>您还没有建立任何的便签<br />在下方你可以快速新建新便签</span>
        </div>
        <div class="note-list" id="note-list">
            <div class="note-list-forceTop" id="note-list-forceTop"></div>
            <div class="note-list-normal" id="note-list-normal"></div>
        </div>
        <script>
            //编辑笔记
            ipcRenderer.on('update-edit-note', (event, data) => {
                updateEditNote(data);
            });

            function updateEditNote(note) {
                notesEdit.saveEditNote(note, function (data) {
                    //reset contents in note
                    switch (sort_mode) {
                        case 'id':
                            updateEditNoteinArray(data); //更新数组内容
                            reRenderEditedNote(data);
                            break;
                        case 'updateDate':
                            updateEditNoteinArray(data, true);
                            break;
                    }
                    //show infobar
                    displayInfobar("success", "笔记内容已保存");
                });
            }
            async function reRenderEditedNote(data) {
                temp = data.text.split('<br/>');
                text = "";
                for (var i = 0; i < temp.length; i++) {
                    s = $("#filter-x").text(temp[i]).html().replace(' ', '&nbsp;');
                    text += s;
                    text += "<br/>";
                }
                final_text = insert_spacing(text, 0.12);
                var html = final_text.replace(reg_url, function (result) {
                    return '<a href="' + result + '">' + result + '</a>';
                });
                var origin_height = $('#note_' + data.id + ' .note-content').height(); //get origin height
                //reset note content on page
                $("#note_" + data.id + " .note-content p").html(html);
                $('#note_' + data.id + ' .note-content').removeClass('note-overheight');
                $('#note_' + data.id + ' .note-content').removeAttr('style');
                var after_height = $('#note_' + data.id + ' .note-content').height();
                //reset content of updatetime
                var timeContent = '<p class="note-time note-updatetime han-element">更新：' +
                    data.updatetime +
                    '</p>' +
                    '<p class="note-time han-element">创建：' + data.time + '</p>';
                $('#note_' + data.id + ' .note-header time').html(timeContent);
                //open external event rebind
                $('#note_' + data.id + ' a').click(function (e) {
                    ipcRenderer.send('openExternalURL', $(this).attr('href'));
                    e.preventDefault();
                });
                //处理标题
                if (typeof data.title != 'undefined') {
                    var titletext = "";
                    if (data.title.length > 50) {
                        titletext = '<titlep1>' + insert_spacing(data.title.substring(0, 16), 0.12) +
                            '</titlep1><titlesusp1>...</titlesusp1><titlep2>' + insert_spacing(data.title.substring(
                                18, 32), 0.12) + '</titlep2><titlesusp2>...</titlesusp2><titlep3>' + insert_spacing(
                                data.title.substring(32, 50), 0.12) +
                            '</titlep3><titlesusp3>...</titlesusp3><titlep4>' + insert_spacing(data.title.substring(
                                50), 0.12) + '</titlep4>';
                    } else if (data.title.length > 32) {
                        titletext = '<titlep1>' + insert_spacing(data.title.substring(0, 16), 0.12) +
                            '</titlep1><titlesusp1>...</titlesusp1><titlep2>' + insert_spacing(data.title.substring(
                                18, 32), 0.12) + '<titlesusp2>...</titlesusp2><titlep3>' + insert_spacing(data.title
                                .substring(32), 0.12) + '</titlep3>';
                    } else if (data.title.length > 16) {
                        titletext = '<titlep1>' + insert_spacing(data.title.substring(0, 16), 0.12) +
                            '</titlep1><titlesusp1>...</titlesusp1><titlep2>' + insert_spacing(data.title.substring(
                                18), 0.12) + '</titlep2>';
                    } else {
                        titletext = insert_spacing(data.title, 0.12);
                    }
                    $('#note_' + data.id + ' .note-header .note-title').html(titletext);
                }
                var tag_class = $('#note_' + data.id + ' .note-content').attr('class');
                //fix note status
                if (after_height >= 250) {
                    if (origin_height <= 250) {
                        bindNoteFoldDBL(data.id);
                        $('#note_' + data.id + ' .note-content').css('height', origin_height);
                        $('#note_' + data.id + ' .note-content').animate({
                            height: "250px"
                        });
                    } else {
                        //already expanded
                        $('#note_' + data.id + ' .note-content').css('height', origin_height);
                        $('#note_' + data.id + ' .note-content').animate({
                            height: after_height
                        });
                    }
                } else {
                    $('#note_' + data.id + ' .note-content').css('height', origin_height);
                    $('#note_' + data.id + ' .note-content').animate({
                        height: after_height
                    });
                    $('#note_' + data.id + ' .note-content').dblclick = function () {}; //unbind event
                    $('#note_' + data.id + ' .note-content').unbind('dblclick');
                }
            }

            //执行notes的替换
            async function updateEditNoteinArray(data, refreshList = false) {
                for (var i = 0; i < notes.length; i++) {
                    if (notes[i].id == data.id) {
                        notes[i] = data;
                        if (refreshList){
                            refreshNoteList();
                        }
                        return;
                    }
                }
            }

            //first start - tooltip
            function addTiptoEmptyInfo() {
                //首次启动在note-empty显示提示
                if (firstStart) {
                    $('.note-empty span').append('<br/>' + insert_spacing('(请使用Ctrl+Enter保存新建笔记)', 0.15));
                }
            }

            //event restore
            ipcRenderer.on('restore-note', (event, data) => {
                if (notes.length <= 0) {
                    showNoteList();
                }
                addNoteObjToArray(data);
                refreshNoteList(function () {
                    bindNoteFoldDBL(data.id);
                });
                //animate
                $('#note_' + data.id).animateCss('fadeInLeft');
            });

            //记录是否有置顶便签
            var hasNotesForceTop = false;
            var hasNotesNotForceTop = false;
            //笔记鼠标点击事件绑定
            function bindNoteClickEvent() {
                //滚动条不响应选择事件
                $('.note-content').off('mousedown').on('mousedown', function (e) {
                    if (e.offsetX >= $('.note-content').width()) {
                        e.stopPropagation();
                    }
                });

                $('.note-wrapper').off('mousedown').on('mousedown', function (e) {
                    //提取点击的id
                    noteid_clicked = parseInt($(this).children('.note').attr("data-id"));
                    if (e.which == 1) {
                        if (selectModeEnabled) {
                            //判断是否为置顶
                            if ($(this).children('.note').hasClass('note-forceTop')) {
                                hasNotesForceTop = true;
                            } else {
                                hasNotesNotForceTop = true;
                            }
                            //多选模式下，单击，如果选中则取消，未选中则选中
                            var index = notes_selected.indexOf(noteid_clicked);
                            if (index != -1) {
                                $('#note_' + noteid_clicked).parent().removeClass('note-selected');
                                notes_selected.removeAt(index);
                                //如果没有选中则退出
                                if (notes_selected.length <= 0) {
                                    selectModeEnabled = false;
                                    $('.toast-multiselected').animateCss('fadeOutRight faster', function () {
                                        $('.toast-multiselected').removeClass('toast-active');
                                    });
                                } else {
                                    $('#toast-multiselected-text').html('当前选择了<handefault/>' + notes_selected
                                        .length + "<handefault/>个便签");
                                }
                            } else {
                                $('#note_' + noteid_clicked).parent().addClass('note-selected');
                                notes_selected.push(noteid_clicked);
                                //set up toast
                                $('#toast-multiselected-text').html('当前选择了<handefault/>' + notes_selected
                                    .length + "<handefault/>个便签");
                            }
                        } else {
                            noteLongClickTimeout = setTimeout(function () {
                                //初始化值
                                selectModeEnabled = true;
                                notes_selected = new Array();
                                hasNotesForceTop = false;
                                hasNotesNotForceTop = false;
                                //对当前所选进行对应处理
                                $('#note_' + noteid_clicked).parent().addClass('note-selected');
                                notes_selected.push(noteid_clicked);
                                //判断是否为置顶
                                if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                    hasNotesForceTop = true;
                                } else {
                                    hasNotesNotForceTop = true;
                                }
                                //set up toast
                                $('.toast-multiselected').addClass('toast-active');
                                $('#toast-multiselected-text').html('当前选择了<handefault/>' +
                                    notes_selected.length + "<handefault/>个便签");
                                $('.toast-multiselected').animateCss('fadeInRight faster');
                                window.getSelection().removeAllRanges();
                            }, 1000);
                        }
                    } else if (e.which == 3) {
                        if (selectModeEnabled) {
                            let index = notes_selected.indexOf(noteid_clicked);
                            //如果是选中的，弹出菜单，如果不是选中的，取消
                            if (index != -1) {
                                //弹出多选下的右键菜单
                                popup_menu_note_multiSelected(hasNotesForceTop, hasNotesNotForceTop);
                            } else {
                                selectModeEnabled = false;
                                $('.note-wrapper').removeClass('note-selected');
                                $(this).addClass('note-selected');
                                if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                    //是置顶便签
                                    popup_menu_note(true);
                                } else {
                                    //不是置顶便签
                                    popup_menu_note(false);
                                }
                                $('.toast-multiselected').animateCss('fadeOutRight faster', function () {
                                    $('.toast-multiselected').removeClass('toast-active');
                                });
                            }
                        } else {
                            $('.note-wrapper').removeClass('note-selected');
                            $(this).addClass('note-selected');
                            if ($('#note_' + noteid_clicked).hasClass('note-forceTop')) {
                                //是置顶便签
                                popup_menu_note(true);
                            } else {
                                //不是置顶便签
                                popup_menu_note(false);
                            }
                        }
                    }
                    //阻止事件冒泡到父元素
                    e.stopPropagation();
                });
                //取消长按的计时器
                $('.note-wrapper').off('mouseup').on('mouseup', function (e) {
                    if (e.which == 1) {
                        clearTimeout(noteLongClickTimeout);
                    }
                });
            }

            //如果移动了鼠标则取消长按计时
            $('body').on('mousemove', function (e) {
                clearTimeout(noteLongClickTimeout);
            });

            $(document).ready(function () {
                //绑定note-list的鼠标点击
                $('#note-list').mousedown(function (e) {
                    if (selectModeEnabled) {
                        selectModeEnabled = false;
                        $('.note-wrapper').removeClass('note-selected');
                        $('.toast-multiselected').animateCss('fadeOutRight faster', function () {
                            $('.toast-multiselected').removeClass('toast-active');
                        });
                    }
                });
            });

            //绑定全选快捷键
            Mousetrap.bind('ctrl+a', function () {
                selectModeEnabled = true;
                notes_selected = new Array();
                notes.forEach(note => {
                    notes_selected.push(note.id);
                });
                $('.note-wrapper').addClass('note-selected');
                if (!$('.toast-multiselected').hasClass('toast-active')) {
                    $('.toast-multiselected').addClass('toast-active');
                    $('.toast-multiselected').animateCss('fadeInRight faster');
                }
                $('#toast-multiselected-text').html('当前选择了<handefault/>' + notes_selected.length +
                    "<handefault/>个便签");
                return false;
            });
        </script>
    </div>

    <!-- new note -->
    <div class="container-newnote">
        <div class="newnote-info-float">
            <div class="newnote-info-item">
                <div class="br-col-2">
                    <label>标题</label>
                </div>
                <div class="br-col-10">
                    <input type="text" class="form-control" id="input-note-title" maxlength="64">
                </div>
            </div>
        </div>
        <div class="newnote-main">
            <div class="lbl">
                <label id="lbl-newnote" title="使用 Ctrl+Enter 提交便签">新建便签</label>
                <!-- fold -->
                <div class="newnote-fold">
                    <button class="br-btn btn-noback newnote-trigger" id="btn-newnote-fold">
                        <i class="fa fa-chevron-down" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="newnote-info">
                    <button class="br-btn btn-noback newnote-trigger" id="btn-newnote-info">
                        <i class="fa fa-info-circle" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <div class="control">
                <textarea id="note-text"></textarea>
            </div>
        </div>
    </div>
    <script>
        var newnote_info_opened = false;
        //绑定btn-newnote-info
        $('#btn-newnote-info').click(function () {
            if (newnote_info_opened) {
                $('.newnote-info-float').animateCss('fadeOutDown faster', function () {
                    $('.newnote-info-float').css('display', 'none');
                    newnote_info_opened = false;
                });
            } else {
                $('.newnote-info-float').css('display', 'block');
                $('.newnote-info-float').animateCss('fadeInUp faster', function () {
                    newnote_info_opened = true;
                });
            }
        });
        $('.container-newnote').click(function () {
            if (newnote_info_opened) {
                $('.newnote-info-float').animateCss('fadeOutDown faster', function () {
                    $('.newnote-info-float').css('display', 'none');
                    newnote_info_opened = false;
                });
            }
        });
        //newnote-info-float 阻止冒泡到上面的事件
        $('.newnote-info-float').click(function (e) {
            e.stopPropagation();
        })
    </script>
    <div class="container-bottombar">
        <div class="trigger-mainmenu">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-mainmenu-trigger">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <div class="trigger-expandnewnote">
            <button class="br-btn btn-noback bottombar-trigger" id="btn-newnote-expand">
                <i class="fa fa-chevron-up"></i>
            </button>
        </div>
        <div class="bottom-bar-statusbar" id="statusbar">
        </div>
    </div>

    <script>
        //折叠开关
        var isNoteFolded = false;
        //init
        storage.get('newnoteconfig', function (err, data) {
            if (err || typeof (data) == 'undefined' || data == null || data == "") {
                isNoteFolded = false;
                $('.container-newnote').css('display', 'block');
                $('.trigger-expandnewnote').css('display', 'none');
                setTimeout(function () {
                    $('.note-list').css('height', $(window).height() - $('.container-titlebar')
                    .height() - 207);
                    $('.note-empty').css('height', $(window).height() - $('.container-titlebar')
                    .height() - 207);
                }, 50);
            } else {
                if (data.isFolded) {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                    $('.trigger-expandnewnote').css('display', 'block');
                    //late execute
                    setTimeout(function () {
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 27);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 27);
                    }, 50);
                } else {
                    isNoteFolded = false;
                    $('.container-newnote').css('display', 'block');
                    $('.trigger-expandnewnote').css('display', 'none');
                    setTimeout(function () {
                        $('.note-list').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 207);
                        $('.note-empty').css('height', $(window).height() - $('.container-titlebar')
                            .height() - 207);
                    }, 50);
                }
            }
        });
        //绑定折叠事件
        $('#btn-newnote-fold').click(function () {
            if (!isNoteFolded) {
                //set config
                var config = {
                    isFolded: true
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 27) +
                    'px');
                //animate
                $('.container-newnote').animateCss('fadeOutDown', function () {
                    $('.container-newnote').css('display', 'none');
                    isNoteFolded = true;
                });
                $('.trigger-expandnewnote').css('display', 'block');
                $('.trigger-expandnewnote').animateCss('fadeIn');
            }
        });
        $('#btn-newnote-expand').click(function () {
            if (isNoteFolded) {
                //set config
                var config = {
                    isFolded: false
                }
                storage.set('newnoteconfig', config);
                //set height
                $('.note-list').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                $('.note-empty').css('height', ($(window).height() - $('.container-titlebar').height() - 207) +
                    'px');
                //animate
                $('.container-newnote').css('display', 'block');
                $('.container-newnote').animateCss('fadeInUp');
                $('.trigger-expandnewnote').animateCss('fadeOut', function () {
                    $('.trigger-expandnewnote').css('display', 'none');
                    isNoteFolded = false;
                });
            }
        });
    </script>

    <!-- import clipboard operation-->
    <script src='static/clipboard.copy.js'></script>

    <script>
        var noteid_clicked = -1;

        function getSelectText(id) {
            var t = document.getElementById(id);
            if (window.getSelection) {
                if (t.selectionStart != undefined && t.selectionEnd != undefined) {
                    return t.value.substring(t.selectionStart, t.selectionEnd);
                } else {
                    return "";
                }
            } else {
                return document.selection.createRange().text;
            }
        }

        $(document).ready(function () {
            bindNewnoteRightClickEvent();
        });

        function bindNewnoteRightClickEvent() {
            $('#note-text').mousedown(function (e) {
                if (e.which == 3) {
                    if ($('#note-text').val().trim().length > 0) {
                        if (getSelectText('note-text').length > 0) {
                            popup_menu_textarea_selected();
                        } else {
                            popup_menu_textarea();
                        }
                    } else {
                        popup_menu_textarea_empty();
                    }
                }
            });
        }
    </script>

    <!-- update -->
    <div class="container-updater">
        <div class="update-block">
            <div class="update-title">
                <span id="update-title-span">检测到新版本：</span>
            </div>
            <div class="update-contents">
                <h1 class="update-contents-title">更新日志</h1>
                <div class="update-contents-details">
                </div>
            </div>

            <div class="update-contents update-contents-loading">
                <span id="update-loading-span">载入中……</span>
            </div>

            <div class="update-footer">
                <div class="control-group" style="-webkit-user-select: none">
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-cancel">取消</button>
                    <button type="button" class="br-btn btn-noback control-item" id="btn-update-confirm">下载</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ipcRenderer -->
    <script>
        let time = require('../app/tools/time.js');
        ipcRenderer.on('update-message', (event, {
            message,
            data
        }) => {
            switch (message) {
                case 'checking-for-update':
                    console.log('checking for update...');
                    break;
                case 'update-available':
                    console.log("update-avaliable...");
                    $('.container-updater').css('display', 'block');
                    $('.container-updater').animateCss('fadeIn', function () {
                        var path_verfile = ``;
                        if (typeof settings != 'undefined') {
                            switch (settings.autoUpdateChannel) {
                                case "0":
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                                    break;
                                case "100":
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/pre-release/${process.platform}/ver.json?time=`;
                                    break;
                                default:
                                    path_verfile =
                                        `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                                    break;
                            }
                        } else {
                            path_verfile =
                                `http://update.backrunner.top/fastnote/${process.platform}/ver.json?time=`;
                        }
                        $.getJSON(path_verfile + time.getRawCurrentMillTime(), //时间戳避免缓存
                            function (result) {
                                if (result != null && result != "" && typeof (result) !=
                                    'undefined') {
                                    try {
                                        $('#update-title-span').text('检测到新版本：' + result.ver);
                                        document.getElementsByClassName('update-contents-details')[
                                            0].innerHTML = insert_spacing(result.text, 0.08);
                                        //check show full
                                        if (result.showfull) {
                                            document.getElementsByClassName(
                                                    'update-contents-details')[
                                                    0].innerHTML +=
                                                '<button class="btn btn-primary brbtn-primary update-contents-showfull" onclick="ipcRenderer.send(\'openExternalURL\', \'https://io.backrunner.top/2018/07/08/Fastnote%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97.html\');">详细更新日志</button>'
                                        }
                                        $('.update-contents-loading').css('display', 'none');
                                    } catch (err) {
                                        console.error(err);
                                        $('#update-loading-span').innerHTML = "更新日志加载失败";
                                    }
                                } else {
                                    $('#update-loading-span').innerHTML = "更新日志加载失败";
                                }
                            }
                        );
                    });
                    break;
                case 'downloadProgress':
                    document.getElementById('update-progress').value = data.percent;
                    document.getElementById('infobar-update-text').innerText = "正在下载更新（" + data.percent.toFixed(
                        1) + " %）......";
                    break;
                case 'update-downloaded':
                    console.log('update-downloaded');
                    //收起上方的通知
                    $('#infobar_update').animateCss('fadeOutUp', function () {
                        $('#infobar_update').remove();
                    });
                    displayInfobar('success', '更新下载完成，关闭程序后将自动安装', 5000);
                    $('#statusbar').append(
                        '<div class="statusbar-item" title="更新下载完毕，重启后安装"><i class="fa fa-arrow-circle-up"></i></div>'
                    );
                case 'error':
                    console.error(data);
                    break;
            }
        });
        //绑定按钮事件
        $('#btn-update-cancel').on('click', function () {
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
            ipcRenderer.send('updateCancelled');
        });
        $('#btn-update-confirm').on('click', function () {
            ipcRenderer.send('downloadNow');
            displayInfobar('update', '正在下载更新……');
            $('.container-updater').animateCss('fadeOut', function () {
                $('.container-updater').removeAttr('style');
            });
        })
    </script>

    <!-- main menu -->
    <div class="mainmenu-background"></div>
    <div class="container-mainmenu">
        <div class="mainmenu-panel">
            <div class="mainmenu-logo">
                <img src="static/images/logo.png" class="mainmenu-logo-default" />
                <img src="static/images/logo.blackwhite.png" class="mainmenu-logo-blackwhite" />
                <h1>Fastnote</h1>
                <span id="mainmenu-version"></span>
                <script>
                    $(document).ready(function () {
                        $('#mainmenu-version').text(version);
                    });
                </script>
            </div>
            <div class="mainmenu-split"></div>
            <div class="mainmenu-menu">
                <ul>
                    <li id="mainmenu-btn-recycle">
                        <span>回收站</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-settings">
                        <span>设置</span>
                    </li>
                    <li id="mainmenu-btn-about">
                        <span>关于</span>
                    </li>
                    <div class="mainmenu-split"></div>
                    <li id="mainmenu-btn-reload">
                        <span>重新载入</span>
                    </li>
                    <li id="mainmenu-btn-exit">
                        <span>退出</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        //绑定主菜单的动画事件
        let isMainMenuOpen = false;
        $('.mainmenu-background').on('mousedown', function () {
            closeMainMenu();
        });
        //打开主菜单
        $('#btn-mainmenu-trigger').on('click', function () {
            if (!isMainMenuOpen) {
                openMainMenu();
            }
        });
        //绑定主菜单快捷键
        Mousetrap.bind('esc', function () {
            if (isMainMenuOpen) {
                closeMainMenu();
            } else {
                openMainMenu();
            }
        });

        function openMainMenu() {
            $('.mainmenu-background').css('display', 'block');
            $('.mainmenu-background').animateCss('fadeIn');
            $('.container-mainmenu').css('display', 'block');
            $('.container-mainmenu').animateCss('fadeInLeft');
            isMainMenuOpen = true;
        }
        //绑定菜单项
        $('#mainmenu-btn-recycle').click(function () {
            ipcRenderer.send("openRecycleWindow");
            closeMainMenu();
        });
        //打开回收站的全局快捷键
        Mousetrap.bind('shift+r', function () {
            ipcRenderer.send("openRecycleWindow");
        });
        $('#mainmenu-btn-settings').click(function () {
            ipcRenderer.send("openSettingsWindow"); //打开关于窗口
            closeMainMenu();
        });
        //打开的设置全局快捷键
        Mousetrap.bind('shift+s', function () {
            ipcRenderer.send("openSettingsWindow");
        });
        $('#mainmenu-btn-about').click(function () {
            ipcRenderer.send("openAboutWindow"); //打开关于窗口
            closeMainMenu();
        });
        $('#mainmenu-btn-reload').click(function () {
            ipcRenderer.send("reloadMainWindow"); //重载
            ipcRenderer.send('reloadRecycleWindow');
            ipcRenderer.send('reloadAllEditWindow');
            ipcRenderer.send('reloadAboutWindow');
            closeMainMenu();
        });
        $('#mainmenu-btn-exit').click(function () {
            ipcRenderer.send("app-quitNow"); //退出程序
            closeMainMenu();
        });

        function closeMainMenu() {
            if (isMainMenuOpen) {
                $('.mainmenu-background').css('width', '100%'); //动态修改宽度防止阻挡
                $('.mainmenu-background').animateCss('fadeOut', function () {
                    $('.mainmenu-background').css('display', 'none');
                })
                $('.container-mainmenu').animateCss('fadeOutLeft', function () {
                    $('.container-mainmenu').css('display', 'none');
                    isMainMenuOpen = false;
                })
            }
        }

        //bind resize
        $(window).resize(function () { //当浏览器大小变化时
            var windowHeight = $(window).height();
            //调整list的高度
            var listHeight = 0;
            if ($('.container-newnote').css('display') == 'none') {
                listHeight = $(window).height() - $('.container-titlebar').height() - 27;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            } else {
                listHeight = $(window).height() - $('.container-titlebar').height() - 207;
                $('.note-list').css('height', listHeight + 'px');
                $('.note-empty').css('height', listHeight + 'px');
            }
            //调整note的高度
            $('.note-content').each(function () {
                if ($(this).attr('class').indexOf('note-overheight') == -1) {
                    $(this).css('height', 'auto');
                }
            });
        });
    </script>

    <script>
        //backup recovered
        ipcRenderer.on('backup-recover-completed', function () {
            console.log('backup recovered');
            //刷新便签列表
            readNoteFiles();
            //获取最大的便签id，刷新为新的便签id
            var maxNoteId = 0;
            //检测NoteID冲突
            var existedNoteId = new Array();
            var conflictNotes = new Array();
            //遍历现有的便签
            notes.forEach(note => {
                if (note.id > maxNoteId) {
                    maxNoteId = note.id;
                }
                //检测noteid是否有冲突，用户在本地的noteid应尽可能保持唯一。
                if (existedNoteId.indexOf(note.id) != -1) {
                    existedNoteId.push(note.id);
                } else {
                    //存在冲突
                    conflictNotes.push(note);
                }
            });
            //重新设置noteid
            notesid = maxNoteId + 1;
            //检测是否存在冲突的便签
            if (conflictNotes.length > 0) {
                //构造细节
                var detail = "存在冲突的便签：\n";
                conflictNotes.forEach(note => {
                    detail += "ID: " + note.id + "，内容: " + (note.text.length > 20 ? note.text.substring(
                        0, 20) + "..." : note.text) + "\n";
                });
                dialog.showMessageBox({
                    title: '便签冲突',
                    message: '恢复备份中的一些便签在ID上和现有便签产生冲突\n便签的ID应是唯一的，否则程序将出现错误。\n请处理冲突',
                    detail: detail,
                    buttons: ['处理冲突', '删除']
                }, function (res) {
                    if (res == 0) {
                        //处理冲突
                        conflictNotes.forEach(note => {
                            note.id = notesid;
                            saveNoteByObj(note);
                            notesid++;
                        });
                        //冲突处理完毕
                        readNoteFiles();
                        saveNotesId();
                    } else if (res == 1) {
                        dialog.showMessageBox({
                            type: 'warning',
                            message: '你确定要自动删除存在冲突的便签吗？',
                            detail: detail,
                            buttons: ['确定', '取消']
                        }, function (res) {
                            if (res == 0) {
                                conflictNotes.forEach(note => {
                                    deleteNoteByObj(note);
                                });
                                //删除完毕
                                readNoteFiles();
                                saveNotesId();
                            }
                        });
                    }
                });
            }
            saveNotesId();
        });
    </script>

    <script>
        //import requirements
        $.getScript('../app/infobar.js'); //import by jQuery
        $.getScript('../app/notes.js');
    </script>

    <span id="filter-x" style="display:none"></span>

</body>

</html>